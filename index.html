<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Inventário - Melhorado</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos customizados para a aparência */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop, .login-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            overflow-y: auto;
            padding: 1rem;
        }
        .modal-content, .login-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        .large-modal-content {
            max-width: 900px;
        }
        .btn {
            @apply text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-50;
        }
        .btn-primary { @apply bg-blue-500 hover:bg-blue-600 focus:ring-blue-400; }
        .btn-green { @apply bg-green-500 hover:bg-green-600 focus:ring-green-400; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400; }
        .btn-red { @apply bg-red-500 hover:bg-red-600 focus:ring-red-400; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400; }
        .btn-purple { @apply bg-purple-500 hover:bg-purple-600 focus:ring-purple-400; }
        
        /* Ocultar elementos por padrão */
        .hidden { display: none; }
        
        /* Estilos para abas */
        .tab-button {
            @apply px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 border-transparent;
        }
        .tab-button.active {
            @apply bg-blue-50 text-blue-600 border-blue-600;
        }
        .tab-button:not(.active) {
            @apply text-gray-500 hover:text-gray-700 hover:border-gray-300;
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">

    <!-- Tela de Login -->
    <div id="loginBackdrop" class="login-backdrop">
        <div class="login-content text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Acessar Inventário</h2>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">Usuário</label>
                    <input type="text" id="loginUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente oculto) -->
    <div id="appContainer" class="hidden max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <header class="mb-6 border-b pb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Sistema de Controle de Inventário</h1>
                <p class="text-sm text-gray-500">Logado como: <span id="loggedInUser" class="font-semibold"></span> (<span id="userRole" class="font-semibold"></span>)</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button id="notificationsBtn" class="relative text-gray-600 hover:text-blue-500 focus:outline-none">
                    <i class="fas fa-bell fa-lg"></i>
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="clearLogBtn" class="btn btn-red admin-only"><i class="fas fa-eraser mr-2"></i>Limpar Log</button>
                <button id="exportLogBtn" class="btn btn-purple admin-only"><i class="fas fa-file-medical-alt mr-2"></i>Exportar Log</button>
                <button id="viewDeletedBtn" class="btn btn-gray admin-editor-only"><i class="fas fa-trash-restore mr-2"></i>Ver Excluídos</button>
                <button id="manageFleetsBtn" class="btn btn-primary admin-editor-only"><i class="fas fa-truck mr-2"></i>Frotas</button>
                <button id="manageUsersBtn" class="btn btn-yellow admin-editor-only"><i class="fas fa-users-cog mr-2"></i>Usuários</button>
                <button id="logoutBtn" class="btn btn-red"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
            </div>
        </header>

        <!-- Barra de Pesquisa e Botões de Ação -->
        <div class="flex flex-wrap gap-3 mb-6">
            <div class="relative flex-grow">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fas fa-search text-gray-400"></i>
                </span>
                <input type="text" id="searchInput" placeholder="Pesquisar por nome do item..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="addItemBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
            <button id="exportBtn" class="btn btn-green admin-editor-only"><i class="fas fa-file-export mr-2"></i>Exportar</button>
        </div>

        <!-- Tabela de Inventário -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Imagem</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome do Item</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status / Qtd.</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Última Alteração</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data/Hora</th>
                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody" class="text-gray-700">
                    <!-- Linhas da tabela serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Item -->
    <div id="itemModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
            <form id="itemForm">
                <input type="hidden" id="originalItemId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="itemType" class="block text-sm font-medium text-gray-700">Tipo de Item</label>
                        <select id="itemType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="consumivel">Consumível</option>
                            <option value="ferramenta">Ferramenta</option>
                            <option value="atribuido">Atribuído</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="itemId" class="block text-sm font-medium text-gray-700">ID do Item</label>
                        <input type="text" id="itemId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="itemName" class="block text-sm font-medium text-gray-700">Nome do Item</label>
                    <input type="text" id="itemName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div id="itemClassContainer" class="mb-4 hidden">
                    <label for="itemClass" class="block text-sm font-medium text-gray-700">Classe do Item</label>
                    <input type="text" id="itemClass" placeholder="Ex: Antena GPS, Monitor" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="itemQuantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="itemQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required min="0">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Imagem do Item</label>
                    <div class="mt-1">
                        <input type="file" id="itemImage" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                    </div>
                    <img id="imagePreview" src="" alt="Prévia da imagem" class="mt-2 rounded-md max-h-32 hidden"/>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelItemBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Entrada/Saída de Estoque (Consumíveis) -->
    <div id="stockModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="stockModalTitle" class="text-2xl font-bold mb-4">Registrar Movimentação</h2>
            <form id="stockForm">
                <input type="hidden" id="stockItemId">
                <input type="hidden" id="stockType">
                <div class="mb-4">
                    <label for="stockQuantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="stockQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required min="1">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelStockBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Unidades (Ferramentas e Atribuídos) -->
    <div id="unitManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 id="unitManagementTitle" class="text-2xl font-bold mb-2">Gerenciar Unidades</h2>
            <p class="mb-4 text-gray-600"><strong>Item:</strong> <span id="unitManagementItemName"></span></p>
            <div id="unitList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Lista de unidades será preenchida aqui -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUnitManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Emprestar/Atribuir Unidade -->
    <div id="assignUnitModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="assignUnitModalTitle" class="text-2xl font-bold mb-4"></h2>
            <form id="assignUnitForm">
                <input type="hidden" id="assignUnitItemId">
                <input type="hidden" id="assignUnitUnitId">
                <div class="mb-4">
                    <label for="assignUnitTo" id="assignUnitToLabel" class="block text-sm font-medium text-gray-700"></label>
                    <input type="text" id="assignUnitTo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="mb-4" id="assignUnitPeriodContainer">
                    <div class="flex items-center gap-4">
                        <div class="flex-grow">
                            <label for="assignUnitPeriod" class="block text-sm font-medium text-gray-700">Prazo (dias)</label>
                            <input type="number" id="assignUnitPeriod" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mt-6">
                            <input type="checkbox" id="assignUnitIndefinite" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="assignUnitIndefinite" class="ml-2 text-sm text-gray-900">Indefinido</label>
                        </div>
                    </div>
                </div>
                <div class="mb-4" id="assignUnitDateContainer">
                    <label for="assignUnitDate" class="block text-sm font-medium text-gray-700">Data de Início</label>
                    <input type="date" id="assignUnitDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4" id="assignUnitIdentifierContainer">
                    <label for="assignUnitIdentifier" class="block text-sm font-medium text-gray-700">Nº de Série / Cód. da Unidade</label>
                    <input type="text" id="assignUnitIdentifier" placeholder="Ex: SN-12345" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelAssignUnitBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Frotas -->
    <div id="fleetManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Frotas</h2>
            
            <!-- Abas -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button id="fleetTabBtn" class="tab-button active" onclick="switchFleetTab('fleet')">
                        <i class="fas fa-truck mr-2"></i>Cadastrar Frotas
                    </button>
                    <button id="assignmentTabBtn" class="tab-button" onclick="switchFleetTab('assignment')">
                        <i class="fas fa-link mr-2"></i>Atribuir Itens
                    </button>
                </nav>
            </div>

            <!-- Aba de Cadastro de Frotas -->
            <div id="fleetTab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <form id="fleetForm">
                            <input type="hidden" id="originalChassi">
                            <h3 class="text-lg font-semibold mb-2 border-b pb-2">Cadastrar/Editar Frota</h3>
                            <div class="mb-4 mt-4">
                                <label for="fleetName" class="block text-sm font-medium text-gray-700">Nome da Frota</label>
                                <input type="text" id="fleetName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="mb-4">
                                <label for="fleetModel" class="block text-sm font-medium text-gray-700">Modelo</label>
                                <input type="text" id="fleetModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="mb-4">
                                <label for="fleetChassi" class="block text-sm font-medium text-gray-700">Chassi (ID Único)</label>
                                <input type="text" id="fleetChassi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="flex justify-end gap-3 mt-6">
                                <button type="button" id="cancelFleetBtn" class="btn btn-gray">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar Frota</button>
                            </div>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Frotas Cadastradas</h3>
                        <div id="fleetList" class="max-h-96 overflow-y-auto space-y-2">
                            <!-- Lista de frotas será preenchida aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba de Atribuição de Itens -->
            <div id="assignmentTab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Selecionar Frota</h3>
                        <div class="mb-4">
                            <label for="selectedFleet" class="block text-sm font-medium text-gray-700">Frota</label>
                            <select id="selectedFleet" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Selecione uma frota...</option>
                            </select>
                        </div>
                        <div id="fleetDetails" class="hidden bg-gray-50 p-4 rounded-md mb-4">
                            <h4 class="font-semibold mb-2">Detalhes da Frota</h4>
                            <p><strong>Nome:</strong> <span id="fleetDetailName"></span></p>
                            <p><strong>Modelo:</strong> <span id="fleetDetailModel"></span></p>
                            <p><strong>Chassi:</strong> <span id="fleetDetailChassi"></span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Itens Atribuídos</h3>
                        <div id="assignedItemsList" class="max-h-96 overflow-y-auto space-y-2">
                            <!-- Lista de itens atribuídos será preenchida aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button type="button" id="closeFleetManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Usuários -->
    <div id="userManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Usuários</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <form id="userForm">
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Adicionar Novo Usuário</h3>
                        <div class="mb-4 mt-4">
                            <label for="newUsername" class="block text-sm font-medium text-gray-700">Usuário</label>
                            <input type="text" id="newUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                            <input type="password" id="newPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newUserRole" class="block text-sm font-medium text-gray-700">Papel</label>
                            <select id="newUserRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="user">Usuário</option>
                                <option value="editor">Editor</option>
                                <option value="admin" id="adminRoleOption">Admin</option>
                            </select>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="submit" class="btn btn-primary">Adicionar Usuário</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2">Usuários Existentes</h3>
                    <div id="userList" class="max-h-96 overflow-y-auto space-y-2">
                        <!-- Lista de usuários será preenchida aqui -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUserManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico -->
    <div id="historyModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Histórico do Item: <span id="historyItemName"></span></h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data/Hora</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Usuário</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ação</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="historyLogBody">
                        <!-- Histórico será inserido aqui -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeHistoryModalBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Itens Excluídos -->
    <div id="deletedItemsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Itens Excluídos</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome do Item</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Excluído Por</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data/Hora Exclusão</th>
                            <th class="py-2 px-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="deletedItemsBody">
                        <!-- Itens excluídos serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeDeletedItemsModalBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações -->
    <div id="notificationsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Notificações</h2>
            <div id="notificationsList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Notificações serão inseridas aqui -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeNotificationsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos do DOM ---
            const loginBackdrop = document.getElementById('loginBackdrop');
            const loginForm = document.getElementById('loginForm');
            const loginUsernameInput = document.getElementById('loginUsername');
            const loginPasswordInput = document.getElementById('loginPassword');
            const appContainer = document.getElementById('appContainer');
            const loggedInUserSpan = document.getElementById('loggedInUser');
            const userRoleSpan = document.getElementById('userRole');
            const logoutBtn = document.getElementById('logoutBtn');
            const searchInput = document.getElementById('searchInput');
            const addItemBtn = document.getElementById('addItemBtn');
            const exportBtn = document.getElementById('exportBtn');
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            const itemModal = document.getElementById('itemModal');
            const modalTitle = document.getElementById('modalTitle');
            const itemForm = document.getElementById('itemForm');
            const cancelItemBtn = document.getElementById('cancelItemBtn');
            const itemTypeSelect = document.getElementById('itemType');
            const itemClassContainer = document.getElementById('itemClassContainer');
            const itemImageInput = document.getElementById('itemImage');
            const imagePreview = document.getElementById('imagePreview');
            const stockModal = document.getElementById('stockModal');
            const stockModalTitle = document.getElementById('stockModalTitle');
            const stockForm = document.getElementById('stockForm');
            const cancelStockBtn = document.getElementById('cancelStockBtn');
            const unitManagementModal = document.getElementById('unitManagementModal');
            const unitManagementTitle = document.getElementById('unitManagementTitle');
            const unitManagementItemName = document.getElementById('unitManagementItemName');
            const unitList = document.getElementById('unitList');
            const closeUnitManagementBtn = document.getElementById('closeUnitManagementBtn');
            const assignUnitModal = document.getElementById('assignUnitModal');
            const assignUnitModalTitle = document.getElementById('assignUnitModalTitle');
            const assignUnitForm = document.getElementById('assignUnitForm');
            const assignUnitToLabel = document.getElementById('assignUnitToLabel');
            const assignUnitPeriodContainer = document.getElementById('assignUnitPeriodContainer');
            const assignUnitDateContainer = document.getElementById('assignUnitDateContainer');
            const assignUnitIdentifierContainer = document.getElementById('assignUnitIdentifierContainer');
            const cancelAssignUnitBtn = document.getElementById('cancelAssignUnitBtn');
            const manageUsersBtn = document.getElementById('manageUsersBtn');
            const userManagementModal = document.getElementById('userManagementModal');
            const userForm = document.getElementById('userForm');
            const userListDiv = document.getElementById('userList');
            const adminRoleOption = document.getElementById('adminRoleOption');
            const closeUserManagementBtn = document.getElementById('closeUserManagementBtn');
            const historyModal = document.getElementById('historyModal');
            const historyItemName = document.getElementById('historyItemName');
            const historyLogBody = document.getElementById('historyLogBody');
            const closeHistoryModalBtn = document.getElementById('closeHistoryModalBtn');
            const viewDeletedBtn = document.getElementById('viewDeletedBtn');
            const deletedItemsModal = document.getElementById('deletedItemsModal');
            const deletedItemsBody = document.getElementById('deletedItemsBody');
            const closeDeletedItemsModalBtn = document.getElementById('closeDeletedItemsModalBtn');
            const clearLogBtn = document.getElementById('clearLogBtn');
            const exportLogBtn = document.getElementById('exportLogBtn');
            const notificationsBtn = document.getElementById('notificationsBtn');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsList = document.getElementById('notificationsList');
            const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
            const manageFleetsBtn = document.getElementById('manageFleetsBtn');
            const fleetManagementModal = document.getElementById('fleetManagementModal');
            const fleetForm = document.getElementById('fleetForm');
            const fleetList = document.getElementById('fleetList');
            const cancelFleetBtn = document.getElementById('cancelFleetBtn');
            const closeFleetManagementBtn = document.getElementById('closeFleetManagementBtn');
            const selectedFleet = document.getElementById('selectedFleet');
            const fleetDetails = document.getElementById('fleetDetails');
            const assignedItemsList = document.getElementById('assignedItemsList');

            // --- Variáveis de Estado ---
            let inventoryItems = [];
            let users = [];
            let currentUser = null;
            let imageBase64 = null;
            let fleets = [];

            const SUPER_ADMIN_USERNAME = 'admin'; // Usuário super admin fixo

            // --- Funções de Armazenamento Local ---
            const getInventory = () => JSON.parse(localStorage.getItem('inventoryItems')) || [];
            const saveInventory = () => localStorage.setItem('inventoryItems', JSON.stringify(inventoryItems));
            const getUsers = () => JSON.parse(localStorage.getItem('users')) || [
                { username: SUPER_ADMIN_USERNAME, password: 'admin', role: 'admin' },
                { username: 'editor', password: 'editor', role: 'editor' },
                { username: 'user', password: 'user', role: 'user' }
            ];
            const saveUsers = (usersToSave) => localStorage.setItem('users', JSON.stringify(usersToSave));
            const getFleets = () => JSON.parse(localStorage.getItem('fleets')) || [];
            const saveFleets = () => localStorage.setItem('fleets', JSON.stringify(fleets));

            // --- Funções de Abas ---
            window.switchFleetTab = (tabName) => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                
                // Add active class to selected tab
                if (tabName === 'fleet') {
                    document.getElementById('fleetTabBtn').classList.add('active');
                    document.getElementById('fleetTab').classList.remove('hidden');
                } else if (tabName === 'assignment') {
                    document.getElementById('assignmentTabBtn').classList.add('active');
                    document.getElementById('assignmentTab').classList.remove('hidden');
                    updateFleetSelector();
                }
            };

            const updateFleetSelector = () => {
                selectedFleet.innerHTML = '<option value="">Selecione uma frota...</option>';
                fleets.forEach(fleet => {
                    const option = document.createElement('option');
                    option.value = fleet.chassi;
                    option.textContent = `${fleet.name} (${fleet.model} - ${fleet.chassi})`;
                    selectedFleet.appendChild(option);
                });
            };

            selectedFleet.addEventListener('change', (e) => {
                const chassi = e.target.value;
                if (chassi) {
                    const fleet = fleets.find(f => f.chassi === chassi);
                    if (fleet) {
                        document.getElementById('fleetDetailName').textContent = fleet.name;
                        document.getElementById('fleetDetailModel').textContent = fleet.model;
                        document.getElementById('fleetDetailChassi').textContent = fleet.chassi;
                        fleetDetails.classList.remove('hidden');
                        updateAssignedItemsList(chassi);
                    }
                } else {
                    fleetDetails.classList.add('hidden');
                    assignedItemsList.innerHTML = '';
                }
            });

            const updateAssignedItemsList = (chassi) => {
                assignedItemsList.innerHTML = '';
                const assignedItems = [];
                
                inventoryItems.forEach(item => {
                    if (item.type === 'atribuido' && item.units) {
                        item.units.forEach(unit => {
                            if (unit.status === 'atribuido' && unit.assignedTo === chassi) {
                                assignedItems.push({
                                    item: item,
                                    unit: unit
                                });
                            }
                        });
                    }
                });

                if (assignedItems.length === 0) {
                    assignedItemsList.innerHTML = '<p class="text-center text-gray-500">Nenhum item atribuído a esta frota.</p>';
                } else {
                    assignedItems.forEach(({ item, unit }) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex justify-between items-center p-3 border rounded-md';
                        itemDiv.innerHTML = `
                            <div>
                                <p class="font-semibold">${item.name} - Unidade ${unit.unitId}</p>
                                <p class="text-sm text-gray-500">Classe: ${item.class || 'N/A'}</p>
                                <p class="text-sm text-gray-500">Nº Série: ${unit.identifier || 'N/A'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="handleEditUnitIdentifier('${item.id}', ${unit.unitId}, '${unit.identifier || ''}')" class="btn btn-gray text-xs"><i class="fas fa-pencil-alt"></i></button>
                                <button onclick="handleUnassignUnit('${item.id}', ${unit.unitId})" class="btn btn-red text-xs">Remover</button>
                            </div>
                        `;
                        assignedItemsList.appendChild(itemDiv);
                    });
                }
            };

            // --- Lógica de Autenticação ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = loginUsernameInput.value;
                const password = loginPasswordInput.value;
                users = getUsers();
                const foundUser = users.find(u => u.username === username && u.password === password);

                if (foundUser) {
                    currentUser = foundUser;
                    showApp();
                } else {
                    alert('Usuário ou senha inválidos.');
                }
            });

            logoutBtn.addEventListener('click', () => {
                currentUser = null;
                hideApp();
                loginBackdrop.classList.remove('hidden');
                loginForm.reset();
            });

            const hideApp = () => {
                appContainer.classList.add('hidden');
            };

            const showApp = () => {
                loginBackdrop.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loggedInUserSpan.textContent = currentUser.username;
                userRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                
                const isAdmin = currentUser.role === 'admin';
                const isEditor = currentUser.role === 'editor';

                document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
                document.querySelectorAll('.admin-editor-only').forEach(el => el.classList.toggle('hidden', !(isAdmin || isEditor)));
                
                loadInventory();
                loadFleets();
            };
            
            const loadInventory = () => {
                inventoryItems = getInventory();
                let dataWasMigrated = false;
                inventoryItems.forEach(item => {
                    if ((item.type === 'ferramenta' || item.type === 'atribuido') && !Array.isArray(item.units)) {
                        item.units = [];
                        for (let i = 1; i <= item.quantity; i++) {
                            item.units.push({ unitId: i, status: 'disponivel', identifier: '' });
                        }
                        dataWasMigrated = true;
                    }
                });

                if (dataWasMigrated) {
                    saveInventory();
                }
                updateNotifications();
                renderTable();
            };

            const loadFleets = () => {
                fleets = getFleets();
            };

            const addHistoryRecord = (item, action, details) => {
                if (!item.history) {
                    item.history = [];
                }
                item.history.unshift({
                    timestamp: new Date().toISOString(),
                    user: currentUser.username,
                    action: action,
                    details: details
                });
            };

            // --- Funções da Tabela ---
            const renderTable = (filter = '') => {
                inventoryTableBody.innerHTML = '';
                const activeItems = inventoryItems.filter(item => !item.isDeleted);
                const filteredItems = activeItems.filter(item => 
                    item && typeof item.name === 'string' && item.name.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredItems.length === 0) {
                    inventoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Nenhum item encontrado.</td></tr>`;
                    return;
                }
                filteredItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = `border-b hover:bg-gray-100 ${item.quantity === 0 && item.type === 'consumivel' ? 'bg-gray-50 text-gray-400' : ''}`;
                    const lastChange = item.history ? item.history[0] : null;
                    
                    const isAdminOrEditor = currentUser.role === 'admin' || currentUser.role === 'editor';
                    
                    let statusOrQtyCell = '';
                    let actionButtons = `<button onclick="handleHistory('${item.id}')" class="text-purple-500 hover:text-purple-700" title="Ver Histórico"><i class="fas fa-history"></i></button>`;

                    if (item.type === 'ferramenta' || item.type === 'atribuido') {
                        const units = item.units || [];
                        const inUseCount = units.filter(u => u.status !== 'disponivel').length;
                        statusOrQtyCell = `<div class="font-semibold">${inUseCount} de ${item.quantity} em uso</div>`;
                        actionButtons += `<button onclick="handleManageUnits('${item.id}')" class="text-indigo-500 hover:text-indigo-700" title="Gerenciar Unidades"><i class="fas fa-tasks"></i></button>`;
                    } else { // Consumível
                        statusOrQtyCell = `<div class="font-bold">${item.quantity}</div>`;
                        actionButtons += `
                            <button onclick="handleStock('${item.id}', 'Entrada')" class="text-green-500 hover:text-green-700" title="Registrar Entrada"><i class="fas fa-arrow-up"></i></button>
                            <button onclick="handleStock('${item.id}', 'Saída')" class="text-yellow-500 hover:text-yellow-700" title="Registrar Saída"><i class="fas fa-arrow-down"></i></button>
                        `;
                    }
                    
                    if (isAdminOrEditor) {
                        actionButtons += `
                            <button onclick="handleEdit('${item.id}')" class="text-blue-500 hover:text-blue-700" title="Editar Item"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDelete('${item.id}')" class="text-red-500 hover:text-red-700" title="Remover Item"><i class="fas fa-trash"></i></button>
                        `;
                    }

                    row.innerHTML = `
                        <td class="py-3 px-4 font-semibold">${item.id}</td>
                        <td class="py-3 px-4">
                            <img src="${item.imageData || 'https://placehold.co/60x60/e2e8f0/a0aec0?text=Sem+Img'}" alt="${item.name}" class="h-12 w-12 object-cover rounded-md">
                        </td>
                        <td class="py-3 px-4">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-xs ${item.type === 'ferramenta' ? 'text-blue-500' : (item.type === 'atribuido' ? 'text-indigo-500' : 'text-gray-500')}">${item.type ? item.type.charAt(0).toUpperCase() + item.type.slice(1) : 'N/D'}</div>
                        </td>
                        <td class="py-3 px-4">${statusOrQtyCell}</td>
                        <td class="py-3 px-4 text-sm">${lastChange ? `${lastChange.user} (${lastChange.action})` : 'N/A'}</td>
                        <td class="py-3 px-4 text-sm">${lastChange ? new Date(lastChange.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center items-center gap-3">
                                ${actionButtons}
                            </div>
                        </td>
                    `;
                    inventoryTableBody.appendChild(row);
                });
            };

            // --- Funções dos Modais ---
            const openItemModal = (item = null) => {
                itemForm.reset();
                imageBase64 = null;
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                itemClassContainer.classList.add('hidden');

                if (item) { // Modo Edição
                    modalTitle.textContent = 'Editar Item';
                    document.getElementById('originalItemId').value = item.id;
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('itemQuantity').value = item.quantity;
                    document.getElementById('itemType').value = item.type || 'consumivel';
                    if (item.type === 'atribuido') {
                        itemClassContainer.classList.remove('hidden');
                        document.getElementById('itemClass').value = item.class || '';
                    }
                    if (item.imageData) {
                        imagePreview.src = item.imageData;
                        imagePreview.classList.remove('hidden');
                        imageBase64 = item.imageData;
                    }
                } else { // Modo Adição
                    modalTitle.textContent = 'Adicionar Novo Item';
                    document.getElementById('originalItemId').value = '';
                    const nextId = inventoryItems.length > 0 ? Math.max(...inventoryItems.map(i => parseInt(i.id) || 0)) + 1 : 1;
                    document.getElementById('itemId').value = nextId;
                }
                
                const isUserRole = currentUser.role === 'user';
                document.getElementById('itemId').disabled = isUserRole && !!item;
                document.getElementById('itemName').disabled = isUserRole && !!item;
                document.getElementById('itemType').disabled = isUserRole && !!item;
                
                itemModal.classList.remove('hidden');
            };

            const closeItemModal = () => itemModal.classList.add('hidden');
            
            const openStockModal = (item, type) => {
                stockForm.reset();
                stockModalTitle.textContent = `Registrar ${type} de ${item.name}`;
                document.getElementById('stockItemId').value = item.id;
                document.getElementById('stockType').value = type;
                stockModal.classList.remove('hidden');
            };
            const closeStockModal = () => stockModal.classList.add('hidden');

            const openUnitManagementModal = (item) => {
                const isTool = item.type === 'ferramenta';
                unitManagementTitle.textContent = isTool ? 'Gerenciar Empréstimos' : 'Gerenciar Atribuições';
                unitManagementItemName.textContent = `${item.name} (ID: ${item.id})`;
                unitList.innerHTML = '';
                item.units.forEach(unit => {
                    const unitDiv = document.createElement('div');
                    unitDiv.className = 'flex flex-wrap justify-between items-center p-3 border rounded-md gap-2';
                    let statusHTML = '';
                    if (unit.status !== 'disponivel') {
                        const target = isTool ? unit.lentTo : unit.assignedTo;
                        let period = '';
                        if (isTool && unit.loanDurationDays) {
                            if (unit.loanDurationDays === -1) {
                                period = '(Indefinido)';
                            } else {
                                const startDate = new Date(unit.loanDate);
                                const endDate = new Date(startDate);
                                endDate.setDate(startDate.getDate() + unit.loanDurationDays);
                                period = `(${unit.loanDurationDays} dias - até ${endDate.toLocaleDateString('pt-BR')})`;
                            }
                        }
                        const identifier = unit.identifier ? `<span class="text-xs text-gray-500 block">Nº Série: ${unit.identifier}</span>` : '';
                        const actionText = isTool ? 'Devolver' : 'Remover';
                        const actionFunc = isTool ? 'handleReturnUnit' : 'handleUnassignUnit';
                        let extendButton = '';
                        let editIdentifierButton = '';

                        if (isTool) {
                            extendButton = `<button onclick="handleExtendLoan('${item.id}', ${unit.unitId})" class="btn btn-yellow text-xs">Prorrogar</button>`;
                        }
                        editIdentifierButton = `<button onclick="handleEditUnitIdentifier('${item.id}', ${unit.unitId}, '${unit.identifier || ''}')" class="btn btn-gray text-xs"><i class="fas fa-pencil-alt"></i></button>`;

                        statusHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold">Unidade ${unit.unitId}</p>
                                <p class="text-sm text-yellow-600">${isTool ? 'Emprestado para' : 'Atribuído a'}: ${target} ${period}</p>
                                ${identifier}
                            </div>
                            <div class="flex gap-2">
                                ${editIdentifierButton}
                                ${extendButton}
                                <button onclick="${actionFunc}('${item.id}', ${unit.unitId})" class="btn btn-red text-xs">${actionText}</button>
                            </div>
                        `;
                    } else {
                        const actionText = isTool ? 'Emprestar' : 'Atribuir';
                        const actionFunc = isTool ? 'handleLendUnit' : 'handleAssignUnit';
                        let editIdentifierButton = `<button onclick="handleEditUnitIdentifier('${item.id}', ${unit.unitId}, '${unit.identifier || ''}')" class="btn btn-gray text-xs"><i class="fas fa-pencil-alt"></i></button>`;

                        statusHTML = `
                            <div>
                                <p class="font-semibold">Unidade ${unit.unitId}</p>
                                <p class="text-sm text-green-600">Disponível</p>
                                ${unit.identifier ? `<span class="text-xs text-gray-500 block">Nº Série: ${unit.identifier}</span>` : ''}
                            </div>
                            <div class="flex gap-2">
                                ${editIdentifierButton}
                                <button onclick="${actionFunc}('${item.id}', ${unit.unitId})" class="btn btn-primary text-xs">${actionText}</button>
                            </div>
                        `;
                    }
                    unitDiv.innerHTML = statusHTML;
                    unitList.appendChild(unitDiv);
                });
                unitManagementModal.classList.remove('hidden');
            };
            const closeUnitManagementModal = () => unitManagementModal.classList.add('hidden');
            
            const openAssignUnitModal = (itemId, unitId, isTool) => {
                assignUnitForm.reset();
                document.getElementById('assignUnitItemId').value = itemId;
                document.getElementById('assignUnitUnitId').value = unitId;
                
                // Set default date to today
                document.getElementById('assignUnitDate').value = new Date().toISOString().split('T')[0];
                
                if (isTool) {
                    assignUnitModalTitle.textContent = `Emprestar Unidade ${unitId}`;
                    assignUnitToLabel.textContent = 'Emprestar para (Nome da Pessoa/Setor):';
                    assignUnitPeriodContainer.classList.remove('hidden');
                    assignUnitDateContainer.classList.remove('hidden');
                    assignUnitIdentifierContainer.classList.add('hidden');
                    // Remove any existing fleet select and revert to text input
                    const currentAssignUnitTo = document.getElementById('assignUnitTo');
                    if (currentAssignUnitTo.tagName === 'SELECT') {
                        const newTextInput = document.createElement('input');
                        newTextInput.type = 'text';
                        newTextInput.id = 'assignUnitTo';
                        newTextInput.className = 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm';
                        newTextInput.required = true;
                        currentAssignUnitTo.parentNode.replaceChild(newTextInput, currentAssignUnitTo);
                    }

                } else { // Atribuído
                    assignUnitModalTitle.textContent = `Atribuir Unidade ${unitId}`;
                    assignUnitToLabel.innerHTML = 'Atribuir à Frota:';
                    
                    const fleetSelect = document.createElement('select');
                    fleetSelect.id = 'assignUnitTo';
                    fleetSelect.className = 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm';
                    fleetSelect.required = true;
                    
                    if (fleets.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Nenhuma frota cadastrada';
                        option.disabled = true;
                        option.selected = true;
                        fleetSelect.appendChild(option);
                    } else {
                        fleets.forEach(fleet => {
                            const option = document.createElement('option');
                            option.value = fleet.chassi;
                            option.textContent = `${fleet.name} (${fleet.model} - ${fleet.chassi})`;
                            fleetSelect.appendChild(option);
                        });
                    }
                    
                    const oldInput = document.getElementById('assignUnitTo');
                    oldInput.parentNode.replaceChild(fleetSelect, oldInput);
                    
                    assignUnitPeriodContainer.classList.add('hidden');
                    assignUnitDateContainer.classList.add('hidden');
                    assignUnitIdentifierContainer.classList.remove('hidden');
                }
                
                assignUnitModal.classList.remove('hidden');
            };
            const closeAssignUnitModal = () => assignUnitModal.classList.add('hidden');
            
            const openUserManagementModal = () => {
                adminRoleOption.classList.toggle('hidden', currentUser.username !== SUPER_ADMIN_USERNAME);
                renderUserList();
                userManagementModal.classList.remove('hidden');
            };
            const closeUserManagementModal = () => userManagementModal.classList.add('hidden');

            const openHistoryModal = (item) => {
                historyItemName.textContent = `${item.name} (ID: ${item.id})`;
                historyLogBody.innerHTML = '';
                if (item.history && item.history.length > 0) {
                    item.history.forEach(log => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-3">${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                            <td class="py-2 px-3">${log.user}</td>
                            <td class="py-2 px-3 font-semibold">${log.action}</td>
                            <td class="py-2 px-3">${log.details}</td>
                        `;
                        historyLogBody.appendChild(row);
                    });
                } else {
                    historyLogBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Nenhum histórico para este item.</td></tr>`;
                }
                historyModal.classList.remove('hidden');
            };
            const closeHistoryModal = () => historyModal.classList.add('hidden');

            const openDeletedItemsModal = () => {
                deletedItemsBody.innerHTML = '';
                const deletedItems = inventoryItems.filter(item => item.isDeleted);
                if (deletedItems.length > 0) {
                    deletedItems.forEach(item => {
                        const deletionRecord = item.history.find(h => h.action === 'Exclusão');
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-3">${item.id}</td>
                            <td class="py-2 px-3">${item.name}</td>
                            <td class="py-2 px-3">${deletionRecord ? deletionRecord.user : 'N/A'}</td>
                            <td class="py-2 px-3">${deletionRecord ? new Date(deletionRecord.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                            <td class="py-2 px-3 text-center">
                                <button onclick="handleRestoreItem('${item.id}')" class="text-green-500 hover:text-green-700" title="Restaurar Item"><i class="fas fa-undo"></i></button>
                            </td>
                        `;
                        deletedItemsBody.appendChild(row);
                    });
                } else {
                    deletedItemsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Nenhum item excluído.</td></tr>`;
                }
                deletedItemsModal.classList.remove('hidden');
            };
            const closeDeletedItemsModal = () => deletedItemsModal.classList.add('hidden');

            const openNotificationsModal = (overdueLoans) => {
                notificationsList.innerHTML = '';
                if (overdueLoans.length > 0) {
                    overdueLoans.forEach(loan => {
                        const notificationDiv = document.createElement('div');
                        notificationDiv.className = 'p-3 border rounded-md bg-red-50';
                        notificationDiv.innerHTML = `
                            <p class="font-semibold">Empréstimo Atrasado: ${loan.itemName} (Unidade ${loan.unitId})</p>
                            <p class="text-sm text-gray-700">Emprestado para: ${loan.lentTo}</p>
                            <p class="text-sm text-red-600">Atrasado em: ${loan.daysOverdue} dias</p>
                        `;
                        notificationsList.appendChild(notificationDiv);
                    });
                } else {
                    notificationsList.innerHTML = `<p class="text-center text-gray-500">Nenhuma notificação no momento.</p>`;
                }
                notificationsModal.classList.remove('hidden');
            };

            const closeNotificationsModal = () => notificationsModal.classList.add('hidden');

            // --- Event Listeners ---
            searchInput.addEventListener('keyup', () => renderTable(searchInput.value));
            addItemBtn.addEventListener('click', () => openItemModal());
            cancelItemBtn.addEventListener('click', closeItemModal);
            cancelStockBtn.addEventListener('click', closeStockModal);
            closeUnitManagementBtn.addEventListener('click', closeUnitManagementModal);
            cancelAssignUnitBtn.addEventListener('click', closeAssignUnitModal);
            manageUsersBtn.addEventListener('click', openUserManagementModal);
            closeUserManagementBtn.addEventListener('click', closeUserManagementModal);
            closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
            viewDeletedBtn.addEventListener('click', openDeletedItemsModal);
            closeDeletedItemsModalBtn.addEventListener('click', closeDeletedItemsModal);
            notificationsBtn.addEventListener('click', () => openNotificationsModal([])); // Pass empty array for initial open
            closeNotificationsBtn.addEventListener('click', closeNotificationsModal);
            manageFleetsBtn.addEventListener('click', () => openFleetManagementModal());
            cancelFleetBtn.addEventListener('click', () => {
                fleetForm.reset();
                document.getElementById('fleetChassi').disabled = false;
            });
            closeFleetManagementBtn.addEventListener('click', closeFleetManagementModal);

            itemTypeSelect.addEventListener('change', (e) => {
                if (e.target.value === 'atribuido') {
                    itemClassContainer.classList.remove('hidden');
                } else {
                    itemClassContainer.classList.add('hidden');
                }
            });

            itemImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        imageBase64 = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            itemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const originalItemId = document.getElementById('originalItemId').value;
                const itemId = document.getElementById('itemId').value;
                const itemName = document.getElementById('itemName').value;
                const itemQuantity = parseInt(document.getElementById('itemQuantity').value);
                const itemType = document.getElementById('itemType').value;
                const itemClass = document.getElementById('itemClass').value;

                if (originalItemId) { // Edição
                    const itemIndex = inventoryItems.findIndex(i => i.id === originalItemId);
                    if (itemIndex !== -1) {
                        const oldItem = { ...inventoryItems[itemIndex] };
                        inventoryItems[itemIndex] = {
                            ...inventoryItems[itemIndex],
                            id: itemId,
                            name: itemName,
                            quantity: itemQuantity,
                            type: itemType,
                            class: itemType === 'atribuido' ? itemClass : undefined,
                            imageData: imageBase64 || oldItem.imageData,
                        };
                        // Adjust units if quantity changed for tools/attributed items
                        if ((itemType === 'ferramenta' || itemType === 'atribuido') && oldItem.quantity !== itemQuantity) {
                            const currentUnits = inventoryItems[itemIndex].units || [];
                            const newUnits = [];
                            for (let i = 1; i <= itemQuantity; i++) {
                                const existingUnit = currentUnits.find(u => u.unitId === i);
                                if (existingUnit) {
                                    newUnits.push(existingUnit);
                                } else {
                                    newUnits.push({ unitId: i, status: 'disponivel', identifier: '' });
                                }
                            }
                            inventoryItems[itemIndex].units = newUnits;
                        }
                        addHistoryRecord(inventoryItems[itemIndex], 'Edição', `Item editado. Antigo ID: ${oldItem.id}, Novo ID: ${itemId}, Nome: ${itemName}, Qtd: ${itemQuantity}, Tipo: ${itemType}.`);
                    }
                } else { // Adição
                    const newItem = {
                        id: itemId,
                        name: itemName,
                        quantity: itemQuantity,
                        type: itemType,
                        class: itemType === 'atribuido' ? itemClass : undefined,
                        imageData: imageBase64,
                        history: [],
                        isDeleted: false
                    };
                    if (itemType === 'ferramenta' || itemType === 'atribuido') {
                        newItem.units = [];
                        for (let i = 1; i <= itemQuantity; i++) {
                            newItem.units.push({ unitId: i, status: 'disponivel', identifier: '' });
                        }
                    }
                    inventoryItems.push(newItem);
                    addHistoryRecord(newItem, 'Adição', `Novo item adicionado: ${itemName} (ID: ${itemId}, Qtd: ${itemQuantity}, Tipo: ${itemType}).`);
                }
                saveInventory();
                loadInventory();
                closeItemModal();
            });

            stockForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemId = document.getElementById('stockItemId').value;
                const type = document.getElementById('stockType').value;
                const quantity = parseInt(document.getElementById('stockQuantity').value);

                const item = inventoryItems.find(i => i.id === itemId);
                if (item) {
                    if (type === 'Entrada') {
                        item.quantity += quantity;
                        addHistoryRecord(item, 'Entrada de Estoque', `Adicionado ${quantity} unidades. Nova quantidade: ${item.quantity}.`);
                    } else if (type === 'Saída') {
                        if (item.quantity >= quantity) {
                            item.quantity -= quantity;
                            addHistoryRecord(item, 'Saída de Estoque', `Removido ${quantity} unidades. Nova quantidade: ${item.quantity}.`);
                        } else {
                            alert('Quantidade em estoque insuficiente.');
                            return;
                        }
                    }
                    saveInventory();
                    loadInventory();
                    closeStockModal();
                }
            });

            assignUnitForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemId = document.getElementById('assignUnitItemId').value;
                const unitId = parseInt(document.getElementById('assignUnitUnitId').value);
                const to = document.getElementById('assignUnitTo').value;
                const period = document.getElementById('assignUnitPeriod').value;
                const isIndefinite = document.getElementById('assignUnitIndefinite').checked;
                const startDate = document.getElementById('assignUnitDate').value;
                const identifier = document.getElementById('assignUnitIdentifier').value;

                const item = inventoryItems.find(i => i.id === itemId);
                const unit = item.units.find(u => u.unitId === unitId);

                if (item.type === 'ferramenta') {
                    unit.status = 'emprestada';
                    unit.lentTo = to;
                    unit.loanDate = startDate ? new Date(startDate).toISOString() : new Date().toISOString();
                    if (isIndefinite) {
                        unit.loanDurationDays = -1; // -1 indica indefinido
                        addHistoryRecord(item, 'Empréstimo', `Unidade ${unitId} emprestada para ${to} (prazo indefinido) em ${new Date(unit.loanDate).toLocaleDateString('pt-BR')}.`);
                    } else {
                        unit.loanDurationDays = parseInt(period);
                        const endDate = new Date(unit.loanDate);
                        endDate.setDate(endDate.getDate() + parseInt(period));
                        addHistoryRecord(item, 'Empréstimo', `Unidade ${unitId} emprestada para ${to} (${period} dias) de ${new Date(unit.loanDate).toLocaleDateString('pt-BR')} até ${endDate.toLocaleDateString('pt-BR')}.`);
                    }
                } else { // Atribuído
                    unit.status = 'atribuido';
                    unit.assignedTo = to;
                    unit.identifier = identifier;
                    const fleetName = fleets.find(f => f.chassi === to)?.name || 'N/A';
                    addHistoryRecord(item, 'Atribuição', `Unidade ${unitId} (ID: ${identifier}) atribuída à frota ${fleetName} (${to}).`);
                }

                saveInventory();
                loadInventory();
                openUnitManagementModal(item);
                closeAssignUnitModal();
            });

            // --- Funções Globais para Ações da Tabela ---
            window.handleEdit = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openItemModal(item);
            };

            window.handleDelete = (id) => {
                if (confirm('Tem certeza que deseja remover este item? Ele será movido para o log de excluídos.')) {
                    const item = inventoryItems.find(i => i.id === id);
                    if (item) {
                        item.isDeleted = true;
                        addHistoryRecord(item, 'Exclusão', 'Item marcado como excluído.');
                        saveInventory();
                        loadInventory();
                    }
                }
            };
            
            window.handleStock = (id, type) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openStockModal(item, type);
            };

            window.handleManageUnits = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if(item) openUnitManagementModal(item);
            };

            window.handleLendUnit = (itemId, unitId) => {
                openAssignUnitModal(itemId, unitId, true);
            };

            window.handleReturnUnit = (itemId, unitId) => {
                const item = inventoryItems.find(i => i.id === itemId);
                const unit = item.units.find(u => u.unitId === unitId);
                if (confirm(`Confirmar a devolução da Unidade ${unitId}?`)) {
                    addHistoryRecord(item, 'Devolução', `Unidade ${unitId} devolvida por ${unit.lentTo}.`);
                    unit.status = 'disponivel';
                    delete unit.lentTo;
                    delete unit.loanDate;
                    delete unit.loanDurationDays;
                    saveInventory();
                    loadInventory();
                    openUnitManagementModal(item);
                }
            };

            window.handleAssignUnit = (itemId, unitId) => {
                openAssignUnitModal(itemId, unitId, false);
            };

            window.handleUnassignUnit = (itemId, unitId) => {
                const item = inventoryItems.find(i => i.id === itemId);
                const unit = item.units.find(u => u.unitId === unitId);
                const fleetName = fleets.find(f => f.chassi === unit.assignedTo)?.name || 'N/A';
                if (confirm(`Remover atribuição da Unidade ${unitId} da frota ${fleetName}?`)) {
                    addHistoryRecord(item, 'Remoção de Atribuição', `Atribuição da Unidade ${unitId} (ID: ${unit.identifier}) removida da frota ${fleetName} (${unit.assignedTo}).`);
                    unit.status = 'disponivel';
                    delete unit.assignedTo;
                    delete unit.identifier;
                    saveInventory();
                    loadInventory();
                    openUnitManagementModal(item);
                    // Update assignment tab if it's open
                    if (selectedFleet.value) {
                        updateAssignedItemsList(selectedFleet.value);
                    }
                }
            };

            window.handleEditUnitIdentifier = (itemId, unitId, currentIdentifier) => {
                const newIdentifier = prompt(`Editar Nº de Série/Cód. da Unidade ${unitId}. Atual: ${currentIdentifier || 'N/A'}\nNovo Nº de Série/Cód.:`);
                if (newIdentifier !== null) { // User didn't cancel
                    const item = inventoryItems.find(i => i.id === itemId);
                    const unit = item.units.find(u => u.unitId === unitId);
                    if (unit) {
                        unit.identifier = newIdentifier.trim();
                        addHistoryRecord(item, 'Edição de Identificador', `Nº de Série/Cód. da Unidade ${unitId} alterado de '${currentIdentifier}' para '${newIdentifier}'.`);
                        saveInventory();
                        loadInventory();
                        openUnitManagementModal(item); // Re-open to show updated identifier
                        // Update assignment tab if it's open
                        if (selectedFleet.value) {
                            updateAssignedItemsList(selectedFleet.value);
                        }
                    }
                }
            };

            window.handleRestoreItem = (id) => {
                if (confirm('Tem certeza que deseja restaurar este item?')) {
                    const item = inventoryItems.find(i => i.id === id);
                    if (item) {
                        item.isDeleted = false;
                        addHistoryRecord(item, 'Restauração', 'Item restaurado do log de excluídos.');
                        saveInventory();
                        loadInventory();
                        closeDeletedItemsModal();
                    }
                }
            };

            window.handleHistory = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openHistoryModal(item);
            };

            // --- Lógica de Gerenciamento de Usuários ---
            userForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUsername = document.getElementById('newUsername').value;
                const newPassword = document.getElementById('newPassword').value;
                const newUserRole = document.getElementById('newUserRole').value;

                let users = getUsers();
                if (users.some(u => u.username === newUsername)) {
                    alert('Nome de usuário já existe.');
                    return;
                }

                if (newUserRole === 'admin' && currentUser.username !== SUPER_ADMIN_USERNAME) {
                    alert('Apenas o admin principal pode adicionar outros admins.');
                    return;
                }

                users.push({ username: newUsername, password: newPassword, role: newUserRole });
                saveUsers(users);
                renderUserList();
                userForm.reset();
                alert('Usuário adicionado com sucesso!');
            });

            const renderUserList = () => {
                userListDiv.innerHTML = '';
                const users = getUsers();
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex justify-between items-center p-2 border rounded-md';
                    
                    let buttons = '';
                    const canBeManaged = user.username !== SUPER_ADMIN_USERNAME && (currentUser.role === 'admin' || (currentUser.role === 'editor' && user.role !== 'admin'));

                    if (canBeManaged) {
                        buttons = `
                            <button onclick="handleChangeRole('${user.username}')" class="text-blue-500 hover:text-blue-700 text-sm" title="Mudar Papel"><i class="fas fa-user-shield"></i></button>
                            <button onclick="handleDeleteUser('${user.username}')" class="text-red-500 hover:text-red-700 text-sm" title="Excluir Usuário"><i class="fas fa-user-times"></i></button>
                        `;
                    } else if (user.username === currentUser.username) {
                        buttons = '<span class="text-xs text-gray-400">Atual</span>';
                    }

                    userDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${user.username}</p>
                            <p class="text-sm text-gray-500">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                        </div>
                        <div class="flex gap-2">
                            ${buttons}
                        </div>
                    `;
                    userListDiv.appendChild(userDiv);
                });
            };

            window.handleChangeRole = (username) => {
                let users = getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    const newRole = prompt(`Digite o novo papel para '${username}' (admin, editor, user):`, user.role);
                    if (newRole && ['admin', 'editor', 'user'].includes(newRole)) {
                        if (newRole === 'admin' && currentUser.username !== SUPER_ADMIN_USERNAME) {
                            alert('Apenas o admin principal pode designar outros admins.');
                            return;
                        }
                        user.role = newRole;
                        saveUsers(users);
                        renderUserList();
                    } else if (newRole !== null) {
                        alert('Papel inválido.');
                    }
                }
            };

            window.handleDeleteUser = (username) => {
                if (confirm(`Tem certeza que deseja excluir o usuário '${username}'? Esta ação não pode ser desfeita.`)) {
                    let users = getUsers().filter(u => u.username !== username);
                    saveUsers(users);
                    renderUserList();
                }
            };

            // --- Lógica de Gerenciamento de Frotas ---
            const openFleetManagementModal = (fleet = null) => {
                fleetForm.reset();
                document.getElementById('originalChassi').value = '';

                if (fleet) { // Modo Edição
                    document.getElementById('originalChassi').value = fleet.chassi;
                    document.getElementById('fleetName').value = fleet.name;
                    document.getElementById('fleetModel').value = fleet.model;
                    document.getElementById('fleetChassi').value = fleet.chassi;
                    document.getElementById('fleetChassi').disabled = true; // Chassi não pode ser editado
                } else { // Modo Adição
                    document.getElementById('fleetChassi').disabled = false;
                }
                renderFleetList();
                updateFleetSelector();
                fleetManagementModal.classList.remove('hidden');
            };

            fleetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const originalChassi = document.getElementById('originalChassi').value;
                const fleetName = document.getElementById('fleetName').value;
                const fleetModel = document.getElementById('fleetModel').value;
                const fleetChassi = document.getElementById('fleetChassi').value;

                if (originalChassi) { // Edição
                    const fleetIndex = fleets.findIndex(f => f.chassi === originalChassi);
                    if (fleetIndex !== -1) {
                        fleets[fleetIndex] = { name: fleetName, model: fleetModel, chassi: fleetChassi };
                        alert('Frota atualizada com sucesso!');
                    }
                } else { // Adição
                    if (fleets.some(f => f.chassi === fleetChassi)) {
                        alert('Chassi já cadastrado. Por favor, use um chassi único.');
                        return;
                    }
                    fleets.push({ name: fleetName, model: fleetModel, chassi: fleetChassi });
                    alert('Frota adicionada com sucesso!');
                }
                saveFleets();
                renderFleetList();
                updateFleetSelector();
                fleetForm.reset();
                document.getElementById('fleetChassi').disabled = false; // Re-enable for new entry
            });

            const renderFleetList = () => {
                fleetList.innerHTML = '';
                if (fleets.length === 0) {
                    fleetList.innerHTML = `<p class="text-center text-gray-500">Nenhuma frota cadastrada.</p>`;
                    return;
                }
                fleets.forEach(fleet => {
                    const fleetDiv = document.createElement('div');
                    fleetDiv.className = 'flex justify-between items-center p-2 border rounded-md';
                    fleetDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${fleet.name}</p>
                            <p class="text-sm text-gray-500">Modelo: ${fleet.model}</p>
                            <p class="text-sm text-gray-500">Chassi: ${fleet.chassi}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleEditFleet('${fleet.chassi}')" class="text-blue-500 hover:text-blue-700 text-sm" title="Editar Frota"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDeleteFleet('${fleet.chassi}')" class="text-red-500 hover:text-red-700 text-sm" title="Excluir Frota"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    fleetList.appendChild(fleetDiv);
                });
            };

            window.handleEditFleet = (chassi) => {
                const fleet = fleets.find(f => f.chassi === chassi);
                if (fleet) openFleetManagementModal(fleet);
            };

            window.handleDeleteFleet = (chassi) => {
                if (confirm(`Tem certeza que deseja excluir a frota com Chassi: ${chassi}?`)) {
                    fleets = fleets.filter(f => f.chassi !== chassi);
                    saveFleets();
                    renderFleetList();
                    updateFleetSelector();
                    alert('Frota excluída com sucesso!');
                }
            };

            // --- Lógica de Ações de Admin ---
            clearLogBtn.addEventListener('click', () => {
                const password = prompt('Para confirmar a limpeza de TODO o histórico, digite sua senha de admin:');
                if (password === null) return;

                const users = getUsers();
                const adminUser = users.find(u => u.username === currentUser.username);

                if (password === adminUser.password) {
                    if (confirm('ATENÇÃO: Esta ação é irreversível e apagará o histórico de TODOS os itens. Deseja continuar?')) {
                        inventoryItems.forEach(item => {
                            item.history = []; // Limpa o histórico
                            addHistoryRecord(item, 'Limpeza de Log', 'O histórico de todos os itens foi apagado.');
                        });
                        saveInventory();
                        loadInventory();
                        alert('Histórico de todos os itens foi limpo com sucesso.');
                    }
                } else {
                    alert('Senha incorreta.');
                }
            });

            // --- Lógica de Exportação ---
            exportBtn.addEventListener('click', () => {
                const activeItems = inventoryItems.filter(item => !item.isDeleted);
                
                const mainData = [];
                const loansData = [];
                const assignmentsData = [];

                activeItems.forEach(item => {
                    const lastChange = item.history ? item.history[0] : null;
                    let statusOrQty = '';

                    if (item.type === 'ferramenta' || item.type === 'atribuido') {
                        const inUseCount = item.units ? item.units.filter(u => u.status !== 'disponivel').length : 0;
                        statusOrQty = `${inUseCount} de ${item.quantity} em uso`;
                        
                        if (item.units) {
                            item.units.forEach(unit => {
                                if (unit.status !== 'disponivel') {
                                    if (item.type === 'ferramenta') {
                                        loansData.push({
                                            'ID do Item': item.id,
                                            'Nome do Item': item.name,
                                            'Unidade': unit.unitId,
                                            'Emprestada para': unit.lentTo,
                                            'Período': unit.loanDurationDays === -1 ? 'Indefinido' : `${unit.loanDurationDays} dias`,
                                            'Data Empréstimo': unit.loanDate ? new Date(unit.loanDate).toLocaleDateString('pt-BR') : 'N/A',
                                            'Data Devolução Prevista': (unit.loanDate && unit.loanDurationDays !== -1) ? new Date(new Date(unit.loanDate).setDate(new Date(unit.loanDate).getDate() + unit.loanDurationDays)).toLocaleDateString('pt-BR') : 'N/A'
                                        });
                                    } else { // Atribuído
                                        assignmentsData.push({
                                            'ID do Item': item.id,
                                            'Nome do Item': item.name,
                                            'Classe': item.class || '',
                                            'Unidade': unit.unitId,
                                            'Identificador da Unidade': unit.identifier || '',
                                            'Atribuído a (Chassi Frota)': unit.assignedTo,
                                            'Nome da Frota': fleets.find(f => f.chassi === unit.assignedTo)?.name || 'N/A'
                                        });
                                    }
                                }
                            });
                        }
                    } else {
                        statusOrQty = item.quantity;
                    }

                    mainData.push({
                        'ID': item.id,
                        'Nome': item.name,
                        'Tipo': item.type,
                        'Classe (se aplicável)': item.class || '',
                        'Status/Qtd': statusOrQty,
                        'Última Alteração Por': lastChange ? lastChange.user : '',
                        'Data/Hora': lastChange ? new Date(lastChange.timestamp).toLocaleString('pt-BR') : ''
                    });
                });

                const wb = XLSX.utils.book_new();
                const wsMain = XLSX.utils.json_to_sheet(mainData);
                XLSX.utils.book_append_sheet(wb, wsMain, "Inventário Geral");

                if (loansData.length > 0) {
                    const wsLoans = XLSX.utils.json_to_sheet(loansData);
                    XLSX.utils.book_append_sheet(wb, wsLoans, "Empréstimos Ativos");
                }
                if (assignmentsData.length > 0) {
                    const wsAssignments = XLSX.utils.json_to_sheet(assignmentsData);
                    XLSX.utils.book_append_sheet(wb, wsAssignments, "Atribuições Ativas");
                }
                
                XLSX.writeFile(wb, "inventario_detalhado.xlsx");
            });
            
            exportLogBtn.addEventListener('click', () => {
                const allLogs = [];
                inventoryItems.forEach(item => {
                    if (item.history) {
                        item.history.forEach(log => {
                            allLogs.push({
                                'ID do Item': item.id,
                                'Nome do Item': item.name,
                                'Data/Hora': new Date(log.timestamp).toLocaleString('pt-BR'),
                                'Usuário': log.user,
                                'Ação': log.action,
                                'Detalhes': log.details
                            });
                        });
                    }
                });

                if (allLogs.length === 0) {
                    alert('Nenhum registro no log para exportar.');
                    return;
                }

                const worksheet = XLSX.utils.json_to_sheet(allLogs);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Log Completo");
                XLSX.writeFile(workbook, "log_completo_inventario.xlsx");
            });

            // --- Lógica de Notificações ---
            const updateNotifications = () => {
                const overdueLoans = [];
                const now = new Date();
                inventoryItems.forEach(item => {
                    if (item.type === 'ferramenta' && item.units) {
                        item.units.forEach(unit => {
                            if (unit.status === 'emprestada' && unit.loanDurationDays !== -1) {
                                const loanDate = new Date(unit.loanDate);
                                const dueDate = new Date(loanDate);
                                dueDate.setDate(loanDate.getDate() + unit.loanDurationDays);
                                if (now > dueDate) {
                                    const diffTime = Math.abs(now - dueDate);
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    overdueLoans.push({
                                        itemName: item.name,
                                        unitId: unit.unitId,
                                        lentTo: unit.lentTo,
                                        daysOverdue: diffDays
                                    });
                                }
                            }
                        });
                    }
                });

                if (overdueLoans.length > 0) {
                    notificationBadge.textContent = overdueLoans.length;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
                
                notificationsBtn.onclick = () => openNotificationsModal(overdueLoans);
            };

            window.handleExtendLoan = (itemId, unitId) => {
                const days = prompt("Prorrogar o empréstimo por quantos dias?");
                if (days && !isNaN(parseInt(days)) && parseInt(days) > 0) {
                    const item = inventoryItems.find(i => i.id === itemId);
                    const unit = item.units.find(u => u.unitId === unitId);
                    
                    if (unit.loanDurationDays === -1) { // Era indefinido
                        unit.loanDate = new Date().toISOString(); // Reinicia a contagem
                        unit.loanDurationDays = parseInt(days);
                    } else {
                        unit.loanDurationDays += parseInt(days);
                    }
                    
                    addHistoryRecord(item, 'Prorrogação', `Empréstimo da Unidade ${unitId} prorrogado por ${days} dias.`);
                    saveInventory();
                    loadInventory();
                    openUnitManagementModal(item);
                } else if (days !== null) {
                    alert("Por favor, insira um número válido de dias.");
                }
            };

            // --- Inicialização ---
            loginBackdrop.classList.remove('hidden');

            // Garante que o super admin existe
            let currentUsers = getUsers();
            if (!currentUsers.some(u => u.username === SUPER_ADMIN_USERNAME)) {
                currentUsers.push({ username: SUPER_ADMIN_USERNAME, password: 'admin', role: 'admin' });
                saveUsers(currentUsers);
            }
        });
    </script>
</body>
</html>

