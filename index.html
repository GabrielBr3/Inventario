<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Inventário</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos customizados para a aparência */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop, .login-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            overflow-y: auto; /* Permite rolagem se o modal for grande */
        }
        .modal-content, .login-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 500px;
            margin: 2rem 0;
        }
        .large-modal-content {
            max-width: 800px;
        }
        .btn {
            @apply text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-50;
        }
        .btn-primary { @apply bg-blue-500 hover:bg-blue-600 focus:ring-blue-400; }
        .btn-green { @apply bg-green-500 hover:bg-green-600 focus:ring-green-400; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400; }
        .btn-red { @apply bg-red-500 hover:bg-red-600 focus:ring-red-400; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400; }
        .btn-purple { @apply bg-purple-500 hover:bg-purple-600 focus:ring-purple-400; }
        
        /* Ocultar elementos por padrão */
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Tela de Login -->
    <div id="loginBackdrop" class="login-backdrop">
        <div class="login-content text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Acessar Inventário</h2>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">Usuário</label>
                    <input type="text" id="loginUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente oculto) -->
    <div id="appContainer" class="hidden max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <header class="mb-6 border-b pb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Sistema de Controle de Inventário</h1>
                <p class="text-gray-500">Logado como: <span id="loggedInUser" class="font-semibold"></span> (<span id="userRole" class="font-semibold"></span>)</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="exportLogBtn" class="btn btn-purple admin-only"><i class="fas fa-file-medical-alt mr-2"></i>Exportar Log</button>
                <button id="viewDeletedBtn" class="btn btn-gray admin-editor-only"><i class="fas fa-trash-restore mr-2"></i>Ver Excluídos</button>
                <button id="manageUsersBtn" class="btn btn-yellow admin-editor-only"><i class="fas fa-users-cog mr-2"></i>Gerenciar Usuários</button>
                <button id="logoutBtn" class="btn btn-red"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
            </div>
        </header>

        <!-- Barra de Pesquisa e Botões de Ação -->
        <div class="flex flex-wrap gap-3 mb-6">
            <div class="relative flex-grow">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fas fa-search text-gray-400"></i>
                </span>
                <input type="text" id="searchInput" placeholder="Pesquisar por nome do item..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="addItemBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
            <button id="exportBtn" class="btn btn-green admin-editor-only"><i class="fas fa-file-export mr-2"></i>Exportar</button>
        </div>

        <!-- Tabela de Inventário -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Imagem</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome do Item</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Quantidade</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Última Alteração</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data/Hora</th>
                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody" class="text-gray-700">
                    <!-- Linhas da tabela serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Item -->
    <div id="itemModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
            <form id="itemForm">
                <input type="hidden" id="originalItemId">
                <div class="mb-4">
                    <label for="itemId" class="block text-sm font-medium text-gray-700">ID do Item</label>
                    <input type="text" id="itemId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="itemName" class="block text-sm font-medium text-gray-700">Nome do Item</label>
                    <input type="text" id="itemName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="itemQuantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="itemQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required min="0">
                </div>
                <div class="mb-4">
                    <label for="itemImage" class="block text-sm font-medium text-gray-700">Imagem do Item</label>
                    <input type="file" id="itemImage" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                    <img id="imagePreview" src="" alt="Prévia da imagem" class="mt-2 rounded-md max-h-32 hidden"/>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelItemBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Entrada/Saída de Estoque -->
    <div id="stockModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="stockModalTitle" class="text-2xl font-bold mb-4">Registrar Movimentação</h2>
            <form id="stockForm">
                <input type="hidden" id="stockItemId">
                <input type="hidden" id="stockType">
                <div class="mb-4">
                    <label for="stockQuantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="stockQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required min="1">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelStockBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Gerenciamento de Usuários (Apenas Admin/Editor) -->
    <div id="userManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Usuários</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <form id="registerUserForm">
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Cadastrar Novo Usuário</h3>
                        <div class="mb-4 mt-4">
                            <label for="newUsername" class="block text-sm font-medium text-gray-700">Novo Usuário</label>
                            <input type="text" id="newUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newPassword" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                            <input type="password" id="newPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newUserRole" class="block text-sm font-medium text-gray-700">Papel</label>
                            <select id="newUserRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="user">Usuário</option>
                                <option value="editor">Editor</option>
                                <option value="admin" id="adminRoleOption">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Cadastrar</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2">Usuários Existentes</h3>
                    <div id="userList" class="mt-4 max-h-64 overflow-y-auto space-y-2">
                        <!-- Lista de usuários será preenchida aqui -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUserManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico do Item -->
    <div id="historyModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-2">Histórico do Item</h2>
            <p class="mb-4 text-gray-600"><strong>Item:</strong> <span id="historyItemName"></span></p>
            <div class="max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Data/Hora</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Usuário</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Ação</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="historyLogBody" class="text-gray-700 text-sm">
                        <!-- Registros do histórico aqui -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeHistoryBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Itens Excluídos (Apenas Admin/Editor) -->
    <div id="deletedItemsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Itens Excluídos</h2>
            <div class="max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full">
                     <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Excluído Por</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Data da Exclusão</th>
                        </tr>
                    </thead>
                    <tbody id="deletedItemsBody" class="text-gray-700 text-sm">
                        <!-- Itens excluídos aqui -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeDeletedItemsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos do DOM ---
            const loginBackdrop = document.getElementById('loginBackdrop');
            const loginForm = document.getElementById('loginForm');
            const appContainer = document.getElementById('appContainer');
            const loggedInUserSpan = document.getElementById('loggedInUser');
            const userRoleSpan = document.getElementById('userRole');
            const logoutBtn = document.getElementById('logoutBtn');
            const manageUsersBtn = document.getElementById('manageUsersBtn');
            const userManagementModal = document.getElementById('userManagementModal');
            const registerUserForm = document.getElementById('registerUserForm');
            const closeUserManagementBtn = document.getElementById('closeUserManagementBtn');
            const userListDiv = document.getElementById('userList');
            const adminRoleOption = document.getElementById('adminRoleOption');
            
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            const searchInput = document.getElementById('searchInput');
            const addItemBtn = document.getElementById('addItemBtn');
            const itemModal = document.getElementById('itemModal');
            const modalTitle = document.getElementById('modalTitle');
            const itemForm = document.getElementById('itemForm');
            const cancelItemBtn = document.getElementById('cancelItemBtn');
            const imagePreview = document.getElementById('imagePreview');
            const itemImageInput = document.getElementById('itemImage');

            const stockModal = document.getElementById('stockModal');
            const stockModalTitle = document.getElementById('stockModalTitle');
            const stockForm = document.getElementById('stockForm');
            const cancelStockBtn = document.getElementById('cancelStockBtn');

            const historyModal = document.getElementById('historyModal');
            const historyItemName = document.getElementById('historyItemName');
            const historyLogBody = document.getElementById('historyLogBody');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            
            const viewDeletedBtn = document.getElementById('viewDeletedBtn');
            const deletedItemsModal = document.getElementById('deletedItemsModal');
            const deletedItemsBody = document.getElementById('deletedItemsBody');
            const closeDeletedItemsBtn = document.getElementById('closeDeletedItemsBtn');

            const exportBtn = document.getElementById('exportBtn');
            const exportLogBtn = document.getElementById('exportLogBtn');

            // --- Estado da Aplicação ---
            let inventoryItems = [];
            let imageBase64 = null;
            let currentUser = null;
            const SUPER_ADMIN_USERNAME = 'GABRIELMAG';

            // --- Funções de Armazenamento ---
            const getUsers = () => JSON.parse(localStorage.getItem('appUsers')) || [];
            const saveUsers = (users) => localStorage.setItem('appUsers', JSON.stringify(users));
            const getInventory = () => JSON.parse(localStorage.getItem('inventoryData')) || [];
            const saveInventory = () => localStorage.setItem('inventoryData', JSON.stringify(inventoryItems));
            
            // --- Funções de Autenticação e UI ---
            const initializeAdmin = () => {
                let users = getUsers();
                if (!users.some(u => u.username === SUPER_ADMIN_USERNAME)) {
                    users.push({ username: SUPER_ADMIN_USERNAME, password: '550323', role: 'admin' });
                    saveUsers(users);
                }
            };

            const checkAuth = () => {
                const userSession = JSON.parse(sessionStorage.getItem('currentUser'));
                if (userSession) {
                    currentUser = userSession;
                    showApp();
                } else {
                    showLogin();
                }
            };

            const showLogin = () => {
                loginBackdrop.classList.remove('hidden');
                appContainer.classList.add('hidden');
            };

            const showApp = () => {
                loginBackdrop.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loggedInUserSpan.textContent = currentUser.username;
                userRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                
                // Controla a visibilidade dos elementos com base no papel do usuário
                const isAdmin = currentUser.role === 'admin';
                const isEditor = currentUser.role === 'editor';

                document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
                document.querySelectorAll('.admin-editor-only').forEach(el => el.classList.toggle('hidden', !(isAdmin || isEditor)));
                
                loadInventory();
            };
            
            const loadInventory = () => {
                inventoryItems = getInventory();
                renderTable();
            };

            const addHistoryRecord = (item, action, details) => {
                if (!item.history) {
                    item.history = [];
                }
                item.history.unshift({
                    timestamp: new Date().toISOString(),
                    user: currentUser.username,
                    action: action,
                    details: details
                });
            };

            // --- Funções da Tabela ---
            const renderTable = (filter = '') => {
                inventoryTableBody.innerHTML = '';
                const activeItems = inventoryItems.filter(item => !item.isDeleted);
                const filteredItems = activeItems.filter(item => 
                    item.name.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredItems.length === 0) {
                    inventoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Nenhum item encontrado.</td></tr>`;
                    return;
                }
                filteredItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = `border-b hover:bg-gray-100 ${item.quantity === 0 ? 'bg-gray-50 text-gray-400' : ''}`;
                    const lastChange = item.history ? item.history[0] : null;
                    
                    const isAdminOrEditor = currentUser.role === 'admin' || currentUser.role === 'editor';

                    let actionButtons = `
                        <button onclick="handleHistory('${item.id}')" class="text-purple-500 hover:text-purple-700" title="Ver Histórico"><i class="fas fa-history"></i></button>
                        <button onclick="handleStock('${item.id}', 'Entrada')" class="text-green-500 hover:text-green-700" title="Registrar Entrada"><i class="fas fa-arrow-up"></i></button>
                        <button onclick="handleStock('${item.id}', 'Saída')" class="text-yellow-500 hover:text-yellow-700" title="Registrar Saída"><i class="fas fa-arrow-down"></i></button>
                    `;
                    
                    if (isAdminOrEditor) {
                        actionButtons += `
                            <button onclick="handleEdit('${item.id}')" class="text-blue-500 hover:text-blue-700" title="Editar Item"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDelete('${item.id}')" class="text-red-500 hover:text-red-700" title="Remover Item"><i class="fas fa-trash"></i></button>
                        `;
                    }

                    row.innerHTML = `
                        <td class="py-3 px-4 font-semibold">${item.id}</td>
                        <td class="py-3 px-4">
                            <img src="${item.imageData || 'https://placehold.co/60x60/e2e8f0/a0aec0?text=Sem+Img'}" alt="${item.name}" class="h-12 w-12 object-cover rounded-md">
                        </td>
                        <td class="py-3 px-4 font-medium">${item.name}</td>
                        <td class="py-3 px-4 font-bold">${item.quantity}</td>
                        <td class="py-3 px-4 text-sm">${lastChange ? `${lastChange.user} (${lastChange.action})` : 'N/A'}</td>
                        <td class="py-3 px-4 text-sm">${lastChange ? new Date(lastChange.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center items-center gap-3">
                                ${actionButtons}
                            </div>
                        </td>
                    `;
                    inventoryTableBody.appendChild(row);
                });
            };

            // --- Funções dos Modais ---
            const openItemModal = (item = null) => {
                itemForm.reset();
                imageBase64 = null;
                imagePreview.classList.add('hidden');
                imagePreview.src = '';

                const isAdminOrEditor = currentUser.role === 'admin' || currentUser.role === 'editor';

                if (item) { // Modo Edição
                    modalTitle.textContent = 'Editar Item';
                    document.getElementById('originalItemId').value = item.id;
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('itemQuantity').value = item.quantity;
                    if (item.imageData) {
                        imagePreview.src = item.imageData;
                        imagePreview.classList.remove('hidden');
                        imageBase64 = item.imageData;
                    }
                } else { // Modo Adição
                    modalTitle.textContent = 'Adicionar Novo Item';
                    document.getElementById('originalItemId').value = '';
                    const nextId = inventoryItems.length > 0 ? Math.max(...inventoryItems.map(i => parseInt(i.id) || 0)) + 1 : 1;
                    document.getElementById('itemId').value = nextId;
                }
                
                // Desabilita campos para usuário normal no modo de edição
                const isUserRole = currentUser.role === 'user';
                document.getElementById('itemId').disabled = isUserRole && !!item;
                document.getElementById('itemName').disabled = isUserRole && !!item;
                
                itemModal.classList.remove('hidden');
            };

            const closeItemModal = () => itemModal.classList.add('hidden');
            
            const openStockModal = (item, type) => {
                stockForm.reset();
                stockModalTitle.textContent = `Registrar ${type} de ${item.name}`;
                document.getElementById('stockItemId').value = item.id;
                document.getElementById('stockType').value = type;
                stockModal.classList.remove('hidden');
            };

            const closeStockModal = () => stockModal.classList.add('hidden');
            
            const openUserManagementModal = () => {
                // Apenas o super admin pode criar outros admins
                adminRoleOption.classList.toggle('hidden', currentUser.username !== SUPER_ADMIN_USERNAME);
                renderUserList();
                userManagementModal.classList.remove('hidden');
            };
            const closeUserManagementModal = () => userManagementModal.classList.add('hidden');

            const openHistoryModal = (item) => {
                historyItemName.textContent = `${item.name} (ID: ${item.id})`;
                historyLogBody.innerHTML = '';
                if (item.history && item.history.length > 0) {
                    item.history.forEach(log => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-3">${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                            <td class="py-2 px-3">${log.user}</td>
                            <td class="py-2 px-3 font-semibold">${log.action}</td>
                            <td class="py-2 px-3">${log.details}</td>
                        `;
                        historyLogBody.appendChild(row);
                    });
                } else {
                    historyLogBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Nenhum histórico para este item.</td></tr>`;
                }
                historyModal.classList.remove('hidden');
            };
            const closeHistoryModal = () => historyModal.classList.add('hidden');

            const openDeletedItemsModal = () => {
                deletedItemsBody.innerHTML = '';
                const deletedItems = inventoryItems.filter(item => item.isDeleted);
                if (deletedItems.length > 0) {
                    deletedItems.forEach(item => {
                        const deletionRecord = item.history.find(h => h.action === 'Exclusão');
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-3">${item.id}</td>
                            <td class="py-2 px-3">${item.name}</td>
                            <td class="py-2 px-3">${deletionRecord ? deletionRecord.user : 'N/A'}</td>
                            <td class="py-2 px-3">${deletionRecord ? new Date(deletionRecord.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                        `;
                        deletedItemsBody.appendChild(row);
                    });
                } else {
                    deletedItemsBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Nenhum item excluído.</td></tr>`;
                }
                deletedItemsModal.classList.remove('hidden');
            };
            const closeDeletedItemsModal = () => deletedItemsModal.classList.add('hidden');

            // --- Manipuladores de Eventos ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const users = getUsers();
                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    checkAuth();
                } else {
                    alert('Usuário ou senha inválidos.');
                }
            });

            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                checkAuth();
            });

            manageUsersBtn.addEventListener('click', openUserManagementModal);
            closeUserManagementBtn.addEventListener('click', closeUserManagementModal);
            viewDeletedBtn.addEventListener('click', openDeletedItemsModal);
            closeDeletedItemsBtn.addEventListener('click', closeDeletedItemsModal);

            registerUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUsername = document.getElementById('newUsername').value;
                const newPassword = document.getElementById('newPassword').value;
                const newUserRole = document.getElementById('newUserRole').value;
                let users = getUsers();

                if (users.some(u => u.username === newUsername)) {
                    alert('Este nome de usuário já existe.');
                    return;
                }

                users.push({ username: newUsername, password: newPassword, role: newUserRole });
                saveUsers(users);
                alert(`Usuário '${newUsername}' cadastrado com sucesso!`);
                registerUserForm.reset();
                renderUserList();
            });
            
            searchInput.addEventListener('input', (e) => renderTable(e.target.value));
            addItemBtn.addEventListener('click', () => openItemModal());
            cancelItemBtn.addEventListener('click', closeItemModal);
            cancelStockBtn.addEventListener('click', closeStockModal);
            closeHistoryBtn.addEventListener('click', closeHistoryModal);
            
            itemImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageBase64 = e.target.result;
                        imagePreview.src = imageBase64;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            itemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const originalId = document.getElementById('originalItemId').value;
                const newId = document.getElementById('itemId').value;
                const name = document.getElementById('itemName').value;
                const quantity = parseInt(document.getElementById('itemQuantity').value);

                if (originalId !== newId && inventoryItems.some(i => i.id === newId && !i.isDeleted)) {
                    alert('Este ID já está em uso por um item ativo. Por favor, escolha outro.');
                    return;
                }

                if (originalId) { // Atualizar item
                    const item = inventoryItems.find(i => i.id == originalId);
                    if (item) {
                        let changes = [];
                        if (item.id !== newId) changes.push(`ID alterado de '${item.id}' para '${newId}'`);
                        if (item.name !== name) changes.push(`Nome alterado de '${item.name}' para '${name}'`);
                        if (item.quantity !== quantity) changes.push(`Quantidade alterada de '${item.quantity}' para '${quantity}'`);
                        
                        if (changes.length > 0) {
                            addHistoryRecord(item, 'Edição', changes.join(', '));
                        }

                        item.id = newId;
                        item.name = name;
                        item.quantity = quantity;
                        item.imageData = imageBase64 || item.imageData;
                    }
                } else { // Adicionar item
                    const newItem = {
                        id: newId, name, quantity, imageData: imageBase64, history: [], isDeleted: false
                    };
                    addHistoryRecord(newItem, 'Criação', `Item criado com ${quantity} unidades.`);
                    inventoryItems.push(newItem);
                }
                saveInventory();
                renderTable();
                closeItemModal();
            });
            
            stockForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('stockItemId').value;
                const type = document.getElementById('stockType').value;
                const quantity = parseInt(document.getElementById('stockQuantity').value);
                
                const item = inventoryItems.find(i => i.id == id);
                if (item) {
                    if (type === 'Saída' && item.quantity < quantity) {
                        alert('Quantidade de saída excede o estoque atual.');
                        return;
                    }
                    
                    const oldQty = item.quantity;
                    item.quantity = type === 'Entrada' ? item.quantity + quantity : item.quantity - quantity;
                    const details = `Quantidade: ${quantity}. Estoque alterado de ${oldQty} para ${item.quantity}.`;
                    addHistoryRecord(item, type, details);
                    
                    saveInventory();
                    renderTable();
                    closeStockModal();
                }
            });

            // --- Funções Globais para Ações da Tabela ---
            window.handleEdit = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openItemModal(item);
            };

            window.handleDelete = (id) => {
                if (confirm('Tem certeza que deseja remover este item? Ele será movido para o log de excluídos.')) {
                    const item = inventoryItems.find(i => i.id === id);
                    if (item) {
                        item.isDeleted = true;
                        addHistoryRecord(item, 'Exclusão', 'Item marcado como excluído.');
                        saveInventory();
                        renderTable();
                    }
                }
            };
            
            window.handleStock = (id, type) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openStockModal(item, type);
            };

            window.handleHistory = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openHistoryModal(item);
            };

            // --- Lógica de Gerenciamento de Usuários ---
            const renderUserList = () => {
                userListDiv.innerHTML = '';
                const users = getUsers();
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex justify-between items-center p-2 border rounded-md';
                    
                    let buttons = '';
                    const canBeManaged = user.username !== SUPER_ADMIN_USERNAME && (currentUser.role === 'admin' || (currentUser.role === 'editor' && user.role !== 'admin'));

                    if (canBeManaged) {
                        buttons = `
                            <button onclick="handleChangeRole('${user.username}')" class="text-blue-500 hover:text-blue-700 text-sm" title="Mudar Papel"><i class="fas fa-user-shield"></i></button>
                            <button onclick="handleDeleteUser('${user.username}')" class="text-red-500 hover:text-red-700 text-sm" title="Excluir Usuário"><i class="fas fa-user-times"></i></button>
                        `;
                    } else if (user.username === currentUser.username) {
                        buttons = '<span class="text-xs text-gray-400">Atual</span>';
                    }

                    userDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${user.username}</p>
                            <p class="text-sm text-gray-500">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                        </div>
                        <div class="flex gap-2">
                            ${buttons}
                        </div>
                    `;
                    userListDiv.appendChild(userDiv);
                });
            };

            window.handleChangeRole = (username) => {
                let users = getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    const newRole = prompt(`Digite o novo papel para '${username}' (admin, editor, user):`, user.role);
                    if (newRole && ['admin', 'editor', 'user'].includes(newRole)) {
                        if (newRole === 'admin' && currentUser.username !== SUPER_ADMIN_USERNAME) {
                            alert('Apenas o admin principal pode designar outros admins.');
                            return;
                        }
                        user.role = newRole;
                        saveUsers(users);
                        renderUserList();
                    } else if (newRole !== null) {
                        alert('Papel inválido.');
                    }
                }
            };

            window.handleDeleteUser = (username) => {
                if (confirm(`Tem certeza que deseja excluir o usuário '${username}'? Esta ação não pode ser desfeita.`)) {
                    let users = getUsers().filter(u => u.username !== username);
                    saveUsers(users);
                    renderUserList();
                }
            };

            // --- Lógica de Exportação ---
            exportBtn.addEventListener('click', () => {
                const activeItems = inventoryItems.filter(item => !item.isDeleted);
                const dataToExport = activeItems.map(item => {
                    const lastChange = item.history ? item.history[0] : null;
                    return {
                        'ID': item.id,
                        'Nome': item.name,
                        'Quantidade': item.quantity,
                        'Última Alteração Por': lastChange ? lastChange.user : '',
                        'Data/Hora': lastChange ? new Date(lastChange.timestamp).toLocaleString('pt-BR') : ''
                    }
                });

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
                XLSX.writeFile(workbook, "inventario_ativo.xlsx");
            });
            
            exportLogBtn.addEventListener('click', () => {
                const allLogs = [];
                inventoryItems.forEach(item => {
                    if (item.history) {
                        item.history.forEach(log => {
                            allLogs.push({
                                'ID do Item': item.id,
                                'Nome do Item': item.name,
                                'Data/Hora': new Date(log.timestamp).toLocaleString('pt-BR'),
                                'Usuário': log.user,
                                'Ação': log.action,
                                'Detalhes': log.details
                            });
                        });
                    }
                });

                if (allLogs.length === 0) {
                    alert('Nenhum registro no log para exportar.');
                    return;
                }

                const worksheet = XLSX.utils.json_to_sheet(allLogs);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Log Completo");
                XLSX.writeFile(workbook, "log_completo_inventario.xlsx");
            });

            // --- Inicialização ---
            initializeAdmin();
            checkAuth();
        });
    </script>
</body>
</html>
