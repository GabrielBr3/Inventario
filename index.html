<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Inventário</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Link para o arquivo CSS externo -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="p-2 sm:p-4 md:p-8">

    <!-- Tela de Login -->
    <div id="loginBackdrop" class="login-backdrop">
        <div class="login-content text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Acessar Inventário</h2>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">Usuário</label>
                    <input type="text" id="loginUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente oculto) -->
    <div id="appContainer" class="hidden max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <header class="mb-6 border-b pb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Sistema de Controle de Inventário</h1>
                <p class="text-sm text-gray-500">Logado como: <span id="loggedInUser" class="font-semibold"></span> (<span id="userRole" class="font-semibold"></span>)</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button id="notificationsBtn" class="relative text-gray-600 hover:text-blue-500 focus:outline-none">
                    <i class="fas fa-bell fa-lg"></i>
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="clearLogBtn" class="btn btn-red admin-only"><i class="fas fa-eraser mr-2"></i>Limpar Log</button>
                <button id="exportLogBtn" class="btn btn-purple admin-only"><i class="fas fa-file-medical-alt mr-2"></i>Exportar Log</button>
                <button id="viewDeletedBtn" class="btn btn-gray admin-editor-only"><i class="fas fa-trash-restore mr-2"></i>Ver Excluídos</button>
                <button id="manageFleetsBtn" class="btn btn-primary admin-editor-only"><i class="fas fa-truck mr-2"></i>Frotas</button>
                <button id="manageUsersBtn" class="btn btn-yellow admin-only"><i class="fas fa-users-cog mr-2"></i>Usuários</button>
                <button id="logoutBtn" class="btn btn-red"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
            </div>
        </header>

        <!-- Barra de Pesquisa e Botões de Ação -->
        <div class="flex flex-wrap gap-3 mb-6">
            <div class="relative flex-grow">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fas fa-search text-gray-400"></i>
                </span>
                <input type="text" id="searchInput" placeholder="Pesquisar por nome do item..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="addItemBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
            <button id="exportBtn" class="btn btn-green admin-editor-only"><i class="fas fa-file-export mr-2"></i>Exportar</button>
        </div>

        <!-- Tabela de Inventário -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Imagem</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome do Item</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status / Qtd.</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Última Alteração</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data/Hora</th>
                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody" class="text-gray-700">
                    <!-- Linhas da tabela serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Item -->
    <div id="itemModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
            <form id="itemForm">
                <input type="hidden" id="originalItemId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="itemType" class="block text-sm font-medium text-gray-700">Tipo de Item</label>
                        <select id="itemType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="consumivel">Consumível</option>
                            <option value="ferramenta">Ferramenta</option>
                            <option value="atribuido">Atribuído</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="itemId" class="block text-sm font-medium text-gray-700">ID do Item</label>
                        <input type="text" id="itemId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="itemName" class="block text-sm font-medium text-gray-700">Nome do Item</label>
                    <input type="text" id="itemName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div id="itemClassContainer" class="mb-4 hidden">
                    <label for="itemClass" class="block text-sm font-medium text-gray-700">Classe do Item</label>
                    <input type="text" id="itemClass" placeholder="Ex: Antena GPS, Monitor" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="itemQuantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="itemQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required min="0">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Imagem do Item</label>
                    <div class="mt-1">
                        <input type="file" id="itemImage" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                    </div>
                    <img id="imagePreview" src="" alt="Prévia da imagem" class="mt-2 rounded-md max-h-32 hidden"/>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelItemBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Entrada/Saída de Estoque (Consumíveis) -->
    <div id="stockModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="stockModalTitle" class="text-2xl font-bold mb-4">Registrar Movimentação</h2>
            <form id="stockForm">
                <input type="hidden" id="stockItemId">
                <input type="hidden" id="stockType">
                <div class="mb-4">
                    <label for="stockQuantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="stockQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required min="1">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelStockBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Unidades (Ferramentas e Atribuídos) -->
    <div id="unitManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 id="unitManagementTitle" class="text-2xl font-bold mb-2">Gerenciar Unidades</h2>
            <p class="mb-4 text-gray-600"><strong>Item:</strong> <span id="unitManagementItemName"></span></p>
            <div id="unitList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Lista de unidades será preenchida aqui -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUnitManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Emprestar/Atribuir Unidade -->
    <div id="assignUnitModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="assignUnitModalTitle" class="text-2xl font-bold mb-4"></h2>
            <form id="assignUnitForm">
                <input type="hidden" id="assignUnitItemId">
                <input type="hidden" id="assignUnitUnitId">
                <div class="mb-4">
                    <label for="assignUnitTo" id="assignUnitToLabel" class="block text-sm font-medium text-gray-700"></label>
                    <div id="assignUnitToContainer"></div>
                </div>
                <div class="mb-4" id="assignUnitPeriodContainer">
                    <div class="flex items-center gap-4">
                        <div class="flex-grow">
                            <label for="assignUnitPeriod" class="block text-sm font-medium text-gray-700">Data de Devolução</label>
                            <input type="date" id="assignUnitPeriod" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mt-6">
                            <input type="checkbox" id="assignUnitIndefinite" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="assignUnitIndefinite" class="ml-2 text-sm text-gray-900">Indefinido</label>
                        </div>
                    </div>
                </div>
                <div class="mb-4" id="assignUnitIdentifierContainer">
                    <label for="assignUnitIdentifier" class="block text-sm font-medium text-gray-700">Nº de Série / Cód. da Unidade</label>
                    <input type="text" id="assignUnitIdentifier" placeholder="Ex: SN-12345" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelAssignUnitBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Frotas -->
    <div id="fleetManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Frotas</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <form id="fleetForm">
                        <input type="hidden" id="originalChassi">
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Cadastrar/Editar Frota</h3>
                        <div class="mb-4 mt-4">
                            <label for="fleetName" class="block text-sm font-medium text-gray-700">Nome da Frota</label>
                            <input type="text" id="fleetName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="fleetModel" class="block text-sm font-medium text-gray-700">Modelo</label>
                            <input type="text" id="fleetModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="fleetChassi" class="block text-sm font-medium text-gray-700">Chassi (ID Único)</label>
                            <input type="text" id="fleetChassi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Salvar Frota</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2">Frotas Cadastradas</h3>
                    <div id="fleetList" class="mt-4 max-h-64 overflow-y-auto space-y-2">
                        <!-- Lista de frotas será preenchida aqui -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeFleetManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Itens Atribuídos à Frota -->
    <div id="fleetItemsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-2">Itens Atribuídos</h2>
            <p class="mb-4 text-gray-600"><strong>Frota:</strong> <span id="fleetItemsName"></span></p>
            <div id="fleetItemsList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Lista de itens atribuídos aqui -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeFleetItemsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Gerenciamento de Usuários (Apenas Admin/Editor) -->
    <div id="userManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Usuários</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <form id="registerUserForm">
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Cadastrar Novo Usuário</h3>
                        <div class="mb-4 mt-4">
                            <label for="newUsername" class="block text-sm font-medium text-gray-700">Novo Usuário</label>
                            <input type="text" id="newUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newPassword" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                            <input type="password" id="newPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newUserRole" class="block text-sm font-medium text-gray-700">Papel</label>
                            <select id="newUserRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="user">Usuário</option>
                                <option value="editor">Editor</option>
                                <option value="admin" id="adminRoleOption">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Cadastrar</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2">Usuários Existentes</h3>
                    <div id="userList" class="mt-4 max-h-64 overflow-y-auto space-y-2">
                        <!-- Lista de usuários será preenchida aqui -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUserManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico do Item -->
    <div id="historyModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-2">Histórico do Item</h2>
            <p class="mb-4 text-gray-600"><strong>Item:</strong> <span id="historyItemName"></span></p>
            <div class="max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Data/Hora</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Usuário</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Ação</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="historyLogBody" class="text-gray-700 text-sm">
                        <!-- Registros do histórico aqui -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeHistoryBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Itens Excluídos (Apenas Admin/Editor) -->
    <div id="deletedItemsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Itens Excluídos</h2>
            <div class="max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full">
                     <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Excluído Por</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase">Data da Exclusão</th>
                        </tr>
                    </thead>
                    <tbody id="deletedItemsBody" class="text-gray-700 text-sm">
                        <!-- Itens excluídos aqui -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeDeletedItemsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações -->
    <div id="notificationsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Notificações de Empréstimos Vencidos</h2>
            <div id="notificationsList" class="max-h-96 overflow-y-auto">
                <!-- Lista de notificações aqui -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeNotificationsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Link para o arquivo JavaScript externo -->
    <script type="module" src="script.js"></script>
</body>
</html>
