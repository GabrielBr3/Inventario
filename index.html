<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Inventário</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos customizados e variáveis de tema */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --header-bg: #f9fafb;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --modal-bg: #ffffff;
            --table-header-bg: #f9fafb;
            --table-row-hover: #f3f4f6;
        }

        html.dark {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg: #1f2937;
            --border-color: #374151;
            --header-bg: #1f2937;
            --input-bg: #374151;
            --input-border: #4b5563;
            --modal-bg: #1f2937;
            --table-header-bg: #374151;
            --table-row-hover: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        #appContainer, .modal-content, .login-content, .table, input, select {
             background-color: var(--card-bg);
             color: var(--text-color);
             border-color: var(--border-color);
        }
        
        thead {
            background-color: var(--table-header-bg);
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

        .modal-backdrop, .login-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            overflow-y: auto;
            padding: 1rem;
        }
        .modal-content, .login-content {
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        .large-modal-content {
            max-width: 800px;
        }
        .xl-modal-content {
            max-width: 1000px;
        }
        .btn {
            @apply text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-50;
        }
        .btn-primary { @apply bg-blue-500 hover:bg-blue-600 focus:ring-blue-400; }
        .btn-green { @apply bg-green-500 hover:bg-green-600 focus:ring-green-400; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400; }
        .btn-red { @apply bg-red-500 hover:bg-red-600 focus:ring-red-400; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400; }
        .btn-purple { @apply bg-purple-500 hover:bg-purple-600 focus:ring-purple-400; }
        
        .hidden { display: none; }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">

    <!-- Tela de Login -->
    <div id="loginBackdrop" class="login-backdrop">
        <div class="login-content text-center">
            <h2 class="text-2xl font-bold mb-6">Acessar Inventário</h2>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="loginUsername" class="block text-sm font-medium">Usuário</label>
                    <input type="text" id="loginUsername" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="loginPassword" class="block text-sm font-medium">Senha</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente oculto) -->
    <div id="appContainer" class="hidden max-w-7xl mx-auto rounded-xl shadow-lg p-4 sm:p-6">
        <header class="mb-6 border-b pb-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold">Sistema de Controle de Inventário</h1>
                <p class="text-sm text-gray-400">Logado como: <span id="loggedInUser" class="font-semibold"></span> (<span id="userRole" class="font-semibold"></span>)</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
                <button id="notificationsBtn" class="relative text-gray-500 dark:text-gray-400 hover:text-blue-500 focus:outline-none">
                    <i class="fas fa-bell fa-lg"></i>
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="viewFleetsBtn" class="btn btn-green"><i class="fas fa-eye mr-2"></i>Visualizar Frotas</button>
                <button id="manageFleetsBtn" class="btn btn-primary admin-editor-only"><i class="fas fa-truck mr-2"></i>Gerenciar Frotas</button>
                <button id="manageUsersBtn" class="btn btn-yellow admin-editor-only"><i class="fas fa-users-cog mr-2"></i>Usuários</button>
                <button id="logoutBtn" class="btn btn-red"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
            </div>
        </header>

        <!-- Barra de Pesquisa e Filtros -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 rounded-lg border">
            <!-- Campo de Pesquisa Geral -->
            <div class="lg:col-span-2">
                <label for="searchInput" class="block text-sm font-medium mb-1">Pesquisar por ID, Nome ou Classe</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                    <input type="text" id="searchInput" placeholder="Digite para pesquisar..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <!-- Filtro por Tipo -->
            <div>
                <label for="filterType" class="block text-sm font-medium mb-1">Filtrar por Tipo</label>
                <select id="filterType" class="w-full py-2 px-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">Todos os Tipos</option>
                    <option value="consumivel">Consumível</option>
                    <option value="ferramenta">Ferramenta</option>
                    <option value="atribuido">Atribuído</option>
                </select>
            </div>
            <!-- Controles de Ordenação -->
            <div>
                <label for="sortBy" class="block text-sm font-medium mb-1">Ordenar por</label>
                <div class="flex gap-2">
                    <select id="sortBy" class="flex-grow py-2 px-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="id">ID</option>
                        <option value="name">Nome</option>
                    </select>
                    <button id="sortOrderBtn" class="px-4 py-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Mudar Ordem">
                        <i id="sortOrderIcon" class="fas fa-arrow-down-1-9"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center gap-3 mb-4">
             <div>
                <button id="viewDeletedBtn" class="btn btn-gray admin-editor-only"><i class="fas fa-trash-restore mr-2"></i>Ver Excluídos</button>
             </div>
             <div class="flex gap-3">
                <button id="exportBtn" class="btn btn-purple admin-editor-only"><i class="fas fa-file-export mr-2"></i>Exportar Inventário</button>
                <button id="addItemBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
             </div>
        </div>

        <!-- Tabela de Inventário -->
        <div class="overflow-x-auto">
            <table class="min-w-full border">
                <thead>
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Imagem</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Nome do Item</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Status / Qtd.</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Última Alteração</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Data/Hora</th>
                        <th class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Linhas da tabela serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Item -->
    <div id="itemModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
            <form id="itemForm">
                <input type="hidden" id="originalItemId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="itemType" class="block text-sm font-medium">Tipo de Item</label>
                        <select id="itemType" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                            <option value="consumivel">Consumível</option>
                            <option value="ferramenta">Ferramenta</option>
                            <option value="atribuido">Atribuído</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="itemId" class="block text-sm font-medium">ID do Item</label>
                        <input type="text" id="itemId" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="itemName" class="block text-sm font-medium">Nome do Item</label>
                    <input type="text" id="itemName" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                </div>
                <div id="itemClassContainer" class="mb-4 hidden">
                    <label for="itemClass" class="block text-sm font-medium">Classe do Item</label>
                    <input type="text" id="itemClass" placeholder="Ex: Antena GPS, Monitor" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="itemQuantity" class="block text-sm font-medium">Quantidade</label>
                    <input type="number" id="itemQuantity" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required min="0">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Imagem do Item</label>
                    <div class="mt-1">
                        <input type="file" id="itemImage" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                    </div>
                    <img id="imagePreview" src="" alt="Prévia da imagem" class="mt-2 rounded-md max-h-32 hidden"/>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelItemBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Visualização de Frotas -->
    <div id="fleetsViewModal" class="modal-backdrop hidden">
        <div class="modal-content xl-modal-content">
            <h2 class="text-2xl font-bold mb-4">Visualização de Frotas e Itens Atribuídos</h2>
            <div id="fleetsViewList" class="max-h-[70vh] overflow-y-auto space-y-4">
                <!-- Conteúdo gerado dinamicamente -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeFleetsViewBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Outros Modais (sem alterações estruturais) -->
    <div id="stockModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="stockModalTitle" class="text-2xl font-bold mb-4">Registrar Movimentação</h2>
            <form id="stockForm">
                <input type="hidden" id="stockItemId">
                <input type="hidden" id="stockType">
                <div class="mb-4">
                    <label for="stockQuantity" class="block text-sm font-medium">Quantidade</label>
                    <input type="number" id="stockQuantity" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required min="1">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelStockBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="unitManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 id="unitManagementTitle" class="text-2xl font-bold mb-2">Gerenciar Unidades</h2>
            <p class="mb-4"><strong>Item:</strong> <span id="unitManagementItemName"></span></p>
            <div id="unitList" class="max-h-96 overflow-y-auto space-y-2"></div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUnitManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <div id="assignUnitModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="assignUnitModalTitle" class="text-2xl font-bold mb-4"></h2>
            <form id="assignUnitForm">
                <input type="hidden" id="assignUnitItemId">
                <input type="hidden" id="assignUnitUnitId">
                <div class="mb-4">
                    <label for="assignUnitTo" id="assignUnitToLabel" class="block text-sm font-medium"></label>
                    <div id="assignUnitToContainer"></div>
                </div>
                <div class="mb-4" id="assignUnitPeriodContainer">
                    <div class="flex items-center gap-4">
                        <div class="flex-grow">
                            <label for="assignUnitPeriod" class="block text-sm font-medium">Data de Devolução</label>
                            <input type="date" id="assignUnitPeriod" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                        </div>
                        <div class="mt-6">
                            <input type="checkbox" id="assignUnitIndefinite" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="assignUnitIndefinite" class="ml-2 text-sm">Indefinido</label>
                        </div>
                    </div>
                </div>
                <div class="mb-4" id="assignUnitIdentifierContainer">
                    <label for="assignUnitIdentifier" class="block text-sm font-medium">Nº de Série / Cód. da Unidade</label>
                    <input type="text" id="assignUnitIdentifier" placeholder="Ex: SN-12345" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelAssignUnitBtn" class="btn btn-gray">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="fleetManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Frotas</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <form id="fleetForm">
                        <input type="hidden" id="originalChassi">
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Cadastrar/Editar Frota</h3>
                        <div class="mb-4 mt-4">
                            <label for="fleetName" class="block text-sm font-medium">Nome da Frota</label>
                            <input type="text" id="fleetName" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="fleetModel" class="block text-sm font-medium">Modelo</label>
                            <input type="text" id="fleetModel" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="fleetChassi" class="block text-sm font-medium">Chassi (ID Único)</label>
                            <input type="text" id="fleetChassi" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Salvar Frota</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2">Frotas Cadastradas</h3>
                    <div id="fleetList" class="mt-4 max-h-64 overflow-y-auto space-y-2"></div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeFleetManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="userManagementModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Usuários</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <form id="registerUserForm">
                        <h3 class="text-lg font-semibold mb-2 border-b pb-2">Cadastrar Novo Usuário</h3>
                        <div class="mb-4 mt-4">
                            <label for="newUsername" class="block text-sm font-medium">Novo Usuário</label>
                            <input type="text" id="newUsername" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newPassword" class="block text-sm font-medium">Nova Senha</label>
                            <input type="password" id="newPassword" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="newUserRole" class="block text-sm font-medium">Papel</label>
                            <select id="newUserRole" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                                <option value="user">Usuário</option>
                                <option value="editor">Editor</option>
                                <option value="admin" id="adminRoleOption">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Cadastrar</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2">Usuários Existentes</h3>
                    <div id="userList" class="mt-4 max-h-64 overflow-y-auto space-y-2"></div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeUserManagementBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-2">Histórico do Item</h2>
            <p class="mb-4"><strong>Item:</strong> <span id="historyItemName"></span></p>
            <div class="max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Data/Hora</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Usuário</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Ação</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="historyLogBody" class="text-sm"></tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeHistoryBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="deletedItemsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Itens Excluídos</h2>
            <div class="max-h-96 overflow-y-auto border rounded-lg">
                <table class="min-w-full">
                     <thead class="sticky top-0">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">ID</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Nome</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Excluído Por</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold uppercase">Data da Exclusão</th>
                        </tr>
                    </thead>
                    <tbody id="deletedItemsBody" class="text-sm"></tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeDeletedItemsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>

    <div id="notificationsModal" class="modal-backdrop hidden">
        <div class="modal-content large-modal-content">
            <h2 class="text-2xl font-bold mb-4">Notificações de Empréstimos Vencidos</h2>
            <div id="notificationsList" class="max-h-96 overflow-y-auto"></div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeNotificationsBtn" class="btn btn-gray">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos do DOM ---
            const loginBackdrop = document.getElementById('loginBackdrop');
            const loginForm = document.getElementById('loginForm');
            const appContainer = document.getElementById('appContainer');
            const loggedInUserSpan = document.getElementById('loggedInUser');
            const userRoleSpan = document.getElementById('userRole');
            const logoutBtn = document.getElementById('logoutBtn');
            const manageUsersBtn = document.getElementById('manageUsersBtn');
            const userManagementModal = document.getElementById('userManagementModal');
            const registerUserForm = document.getElementById('registerUserForm');
            const closeUserManagementBtn = document.getElementById('closeUserManagementBtn');
            const userListDiv = document.getElementById('userList');
            const adminRoleOption = document.getElementById('adminRoleOption');
            
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            const searchInput = document.getElementById('searchInput');
            const filterType = document.getElementById('filterType');
            const sortBy = document.getElementById('sortBy');
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            const sortOrderIcon = document.getElementById('sortOrderIcon');

            const addItemBtn = document.getElementById('addItemBtn');
            const itemModal = document.getElementById('itemModal');
            const modalTitle = document.getElementById('modalTitle');
            const itemForm = document.getElementById('itemForm');
            const itemTypeSelect = document.getElementById('itemType');
            const itemClassContainer = document.getElementById('itemClassContainer');
            const cancelItemBtn = document.getElementById('cancelItemBtn');
            const imagePreview = document.getElementById('imagePreview');
            const itemImageInput = document.getElementById('itemImage');

            const stockModal = document.getElementById('stockModal');
            const stockModalTitle = document.getElementById('stockModalTitle');
            const stockForm = document.getElementById('stockForm');
            const cancelStockBtn = document.getElementById('cancelStockBtn');

            const unitManagementModal = document.getElementById('unitManagementModal');
            const unitManagementTitle = document.getElementById('unitManagementTitle');
            const unitManagementItemName = document.getElementById('unitManagementItemName');
            const unitList = document.getElementById('unitList');
            const closeUnitManagementBtn = document.getElementById('closeUnitManagementBtn');

            const assignUnitModal = document.getElementById('assignUnitModal');
            const assignUnitForm = document.getElementById('assignUnitForm');
            const assignUnitModalTitle = document.getElementById('assignUnitModalTitle');
            const assignUnitToLabel = document.getElementById('assignUnitToLabel');
            const assignUnitToContainer = document.getElementById('assignUnitToContainer');
            const assignUnitPeriodContainer = document.getElementById('assignUnitPeriodContainer');
            const assignUnitIdentifierContainer = document.getElementById('assignUnitIdentifierContainer');
            const assignUnitIndefinite = document.getElementById('assignUnitIndefinite');
            const assignUnitPeriod = document.getElementById('assignUnitPeriod');
            const cancelAssignUnitBtn = document.getElementById('cancelAssignUnitBtn');

            const fleetManagementModal = document.getElementById('fleetManagementModal');
            const fleetForm = document.getElementById('fleetForm');
            const fleetList = document.getElementById('fleetList');
            const manageFleetsBtn = document.getElementById('manageFleetsBtn');
            const closeFleetManagementBtn = document.getElementById('closeFleetManagementBtn');
            
            const viewFleetsBtn = document.getElementById('viewFleetsBtn');
            const fleetsViewModal = document.getElementById('fleetsViewModal');
            const fleetsViewList = document.getElementById('fleetsViewList');
            const closeFleetsViewBtn = document.getElementById('closeFleetsViewBtn');

            const historyModal = document.getElementById('historyModal');
            const historyItemName = document.getElementById('historyItemName');
            const historyLogBody = document.getElementById('historyLogBody');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            
            const viewDeletedBtn = document.getElementById('viewDeletedBtn');
            const deletedItemsModal = document.getElementById('deletedItemsModal');
            const deletedItemsBody = document.getElementById('deletedItemsBody');
            const closeDeletedItemsBtn = document.getElementById('closeDeletedItemsBtn');

            const exportBtn = document.getElementById('exportBtn');

            const notificationsBtn = document.getElementById('notificationsBtn');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsList = document.getElementById('notificationsList');
            const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
            
            const themeToggleButton = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

            // --- Estado da Aplicação ---
            let inventoryItems = [];
            let fleets = [];
            let imageBase64 = null;
            let currentUser = null;
            let currentSortOrder = 'asc'; // 'asc' ou 'desc'
            const SUPER_ADMIN_USERNAME = 'GABRIELMAG';

            // --- Funções de Armazenamento ---
            const getUsers = () => JSON.parse(localStorage.getItem('appUsers')) || [];
            const saveUsers = (users) => localStorage.setItem('appUsers', JSON.stringify(users));
            const getInventory = () => JSON.parse(localStorage.getItem('inventoryData')) || [];
            const saveInventory = () => localStorage.setItem('inventoryData', JSON.stringify(inventoryItems));
            const getFleets = () => JSON.parse(localStorage.getItem('appFleets')) || [];
            const saveFleets = () => localStorage.setItem('appFleets', JSON.stringify(fleets));
            
            // --- Funções de Autenticação e UI ---
            const initializeAdmin = () => {
                let users = getUsers();
                if (!users.some(u => u.username === SUPER_ADMIN_USERNAME)) {
                    users.push({ username: SUPER_ADMIN_USERNAME, password: '550323', role: 'admin' });
                    saveUsers(users);
                }
            };

            const checkAuth = () => {
                const userSession = JSON.parse(sessionStorage.getItem('currentUser'));
                if (userSession) {
                    currentUser = userSession;
                    showApp();
                } else {
                    showLogin();
                }
            };

            const showLogin = () => {
                loginBackdrop.classList.remove('hidden');
                appContainer.classList.add('hidden');
            };

            const showApp = () => {
                loginBackdrop.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loggedInUserSpan.textContent = currentUser.username;
                userRoleSpan.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                
                const isAdmin = currentUser.role === 'admin';
                const isEditor = currentUser.role === 'editor';

                document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
                document.querySelectorAll('.admin-editor-only').forEach(el => el.classList.toggle('hidden', !(isAdmin || isEditor)));
                
                loadInventory();
                loadFleets();
            };
            
            const loadInventory = () => {
                inventoryItems = getInventory();
                let dataWasMigrated = false;
                inventoryItems.forEach(item => {
                    if ((item.type === 'ferramenta' || item.type === 'atribuido') && !Array.isArray(item.units)) {
                        item.units = [];
                        for (let i = 1; i <= item.quantity; i++) {
                            item.units.push({ unitId: i, status: 'disponivel' });
                        }
                        dataWasMigrated = true;
                    }
                });

                if (dataWasMigrated) {
                    saveInventory();
                }
                updateNotifications();
                renderTable();
            };

            const loadFleets = () => {
                fleets = getFleets();
            };

            const addHistoryRecord = (item, action, details) => {
                if (!item.history) {
                    item.history = [];
                }
                item.history.unshift({
                    timestamp: new Date().toISOString(),
                    user: currentUser.username,
                    action: action,
                    details: details
                });
            };

            // --- Funções da Tabela (com Filtros e Ordenação) ---
            const renderTable = () => {
                inventoryTableBody.innerHTML = '';
                
                const searchValue = searchInput.value.toLowerCase();
                const typeValue = filterType.value;
                const sortByValue = sortBy.value;

                let filteredItems = inventoryItems.filter(item => !item.isDeleted);

                if (searchValue) {
                    filteredItems = filteredItems.filter(item => 
                        (item.name && item.name.toLowerCase().includes(searchValue)) ||
                        (item.id && item.id.toLowerCase().includes(searchValue)) ||
                        (item.class && item.class.toLowerCase().includes(searchValue))
                    );
                }

                if (typeValue !== 'all') {
                    filteredItems = filteredItems.filter(item => item.type === typeValue);
                }

                filteredItems.sort((a, b) => {
                    let valA, valB;
                    if (sortByValue === 'id') {
                        valA = parseInt(a.id, 10) || 0;
                        valB = parseInt(b.id, 10) || 0;
                        return valA - valB;
                    } else { 
                        valA = (a.name || '').toLowerCase();
                        valB = (b.name || '').toLowerCase();
                        return valA.localeCompare(valB);
                    }
                });

                if (currentSortOrder === 'desc') {
                    filteredItems.reverse();
                }

                if (filteredItems.length === 0) {
                    inventoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10">Nenhum item encontrado.</td></tr>`;
                    return;
                }

                filteredItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = `border-b ${item.quantity === 0 && item.type === 'consumivel' ? 'opacity-50' : ''}`;
                    const lastChange = item.history ? item.history[0] : null;
                    
                    const isAdminOrEditor = currentUser.role === 'admin' || currentUser.role === 'editor';
                    
                    let statusOrQtyCell = '';
                    let actionButtons = `<button onclick="handleHistory('${item.id}')" class="text-purple-500 hover:text-purple-700" title="Ver Histórico"><i class="fas fa-history"></i></button>`;

                    if (item.type === 'ferramenta' || item.type === 'atribuido') {
                        const units = item.units || [];
                        const inUseCount = units.filter(u => u.status !== 'disponivel').length;
                        statusOrQtyCell = `<div class="font-semibold">${inUseCount} de ${item.quantity} em uso</div>`;
                        actionButtons += `<button onclick="handleManageUnits('${item.id}')" class="text-indigo-500 hover:text-indigo-700" title="Gerenciar Unidades"><i class="fas fa-tasks"></i></button>`;
                    } else { // Consumível
                        statusOrQtyCell = `<div class="font-bold">${item.quantity}</div>`;
                        if (isAdminOrEditor) {
                            actionButtons += `
                                <button onclick="handleStock('${item.id}', 'Entrada')" class="text-green-500 hover:text-green-700" title="Registrar Entrada"><i class="fas fa-arrow-up"></i></button>
                                <button onclick="handleStock('${item.id}', 'Saída')" class="text-yellow-500 hover:text-yellow-700" title="Registrar Saída"><i class="fas fa-arrow-down"></i></button>
                            `;
                        }
                    }
                    
                    if (isAdminOrEditor) {
                        actionButtons += `
                            <button onclick="handleEdit('${item.id}')" class="text-blue-500 hover:text-blue-700" title="Editar Item"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDelete('${item.id}')" class="text-red-500 hover:text-red-700" title="Remover Item"><i class="fas fa-trash"></i></button>
                        `;
                    }

                    row.innerHTML = `
                        <td class="py-3 px-4 font-semibold">${item.id}</td>
                        <td class="py-3 px-4">
                            <img src="${item.imageData || 'https://placehold.co/60x60/e2e8f0/a0aec0?text=Sem+Img'}" alt="${item.name}" class="h-12 w-12 object-cover rounded-md">
                        </td>
                        <td class="py-3 px-4">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-xs ${item.type === 'ferramenta' ? 'text-blue-500' : (item.type === 'atribuido' ? 'text-indigo-500' : 'text-gray-500')}">${item.type ? item.type.charAt(0).toUpperCase() + item.type.slice(1) : 'N/D'}</div>
                        </td>
                        <td class="py-3 px-4">${statusOrQtyCell}</td>
                        <td class="py-3 px-4 text-sm">${lastChange ? `${lastChange.user} (${lastChange.action})` : 'N/A'}</td>
                        <td class="py-3 px-4 text-sm">${lastChange ? new Date(lastChange.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center items-center gap-3">
                                ${actionButtons}
                            </div>
                        </td>
                    `;
                    inventoryTableBody.appendChild(row);
                });
            };

            // --- Funções dos Modais ---
            const openItemModal = (item = null) => {
                itemForm.reset();
                imageBase64 = null;
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                itemClassContainer.classList.add('hidden');

                if (item) { // Modo Edição
                    modalTitle.textContent = 'Editar Item';
                    document.getElementById('originalItemId').value = item.id;
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('itemQuantity').value = item.quantity;
                    document.getElementById('itemType').value = item.type || 'consumivel';
                    if (item.type === 'atribuido') {
                        itemClassContainer.classList.remove('hidden');
                        document.getElementById('itemClass').value = item.class || '';
                    }
                    if (item.imageData) {
                        imagePreview.src = item.imageData;
                        imagePreview.classList.remove('hidden');
                        imageBase64 = item.imageData;
                    }
                } else { // Modo Adição
                    modalTitle.textContent = 'Adicionar Novo Item';
                    document.getElementById('originalItemId').value = '';
                    const nextId = inventoryItems.length > 0 ? Math.max(...inventoryItems.map(i => parseInt(i.id) || 0)) + 1 : 1;
                    document.getElementById('itemId').value = nextId;
                }
                
                itemModal.classList.remove('hidden');
            };

            const closeItemModal = () => itemModal.classList.add('hidden');
            
             const openStockModal = (item, type) => {
                stockForm.reset();
                stockModalTitle.textContent = `Registrar ${type} de ${item.name}`;
                document.getElementById('stockItemId').value = item.id;
                document.getElementById('stockType').value = type;
                stockModal.classList.remove('hidden');
            };
            const closeStockModal = () => stockModal.classList.add('hidden');

            const openUnitManagementModal = (item) => {
                const isTool = item.type === 'ferramenta';
                unitManagementTitle.textContent = isTool ? 'Gerenciar Empréstimos' : 'Gerenciar Atribuições';
                unitManagementItemName.textContent = `${item.name} (ID: ${item.id})`;
                unitList.innerHTML = '';
                item.units.forEach(unit => {
                    const unitDiv = document.createElement('div');
                    unitDiv.className = 'flex flex-wrap justify-between items-center p-3 border rounded-md gap-2';
                    let statusHTML = '';
                    if (unit.status !== 'disponivel') {
                        const target = isTool ? unit.lentTo : fleets.find(f => f.chassi === unit.assignedTo)?.name || unit.assignedTo;
                        const period = isTool && unit.dueDate ? (unit.dueDate === 'Indefinido' ? '(Indefinido)' : `(Devolver até: ${new Date(unit.dueDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})})`) : '';
                        const identifier = unit.identifier ? `<span class="text-xs block">Nº Série: ${unit.identifier}</span>` : '';
                        const actionText = isTool ? 'Devolver' : 'Remover';
                        const actionFunc = isTool ? 'handleReturnUnit' : 'handleUnassignUnit';
                        let extendButton = '';
                        if (isTool) {
                            extendButton = `<button onclick="handleExtendLoan('${item.id}', ${unit.unitId})" class="btn btn-yellow text-xs">Prorrogar</button>`;
                        }
                        statusHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold">Unidade ${unit.unitId}</p>
                                <p class="text-sm text-yellow-500">${isTool ? 'Emprestado para' : 'Atribuído a'}: ${target} ${period}</p>
                                ${identifier}
                            </div>
                            <div class="flex gap-2">
                                ${extendButton}
                                <button onclick="${actionFunc}('${item.id}', ${unit.unitId})" class="btn btn-red text-xs">${actionText}</button>
                            </div>
                        `;
                    } else {
                        const actionText = isTool ? 'Emprestar' : 'Atribuir';
                        const actionFunc = isTool ? 'handleLendUnit' : 'handleAssignUnit';
                        statusHTML = `
                            <div>
                                <p class="font-semibold">Unidade ${unit.unitId}</p>
                                <p class="text-sm text-green-500">Disponível</p>
                            </div>
                            <button onclick="${actionFunc}('${item.id}', ${unit.unitId})" class="btn btn-primary text-xs">${actionText}</button>
                        `;
                    }
                    unitDiv.innerHTML = statusHTML;
                    unitList.appendChild(unitDiv);
                });
                unitManagementModal.classList.remove('hidden');
            };
            const closeUnitManagementModal = () => unitManagementModal.classList.add('hidden');
            
            const openAssignUnitModal = (itemId, unitId, isTool) => {
                assignUnitForm.reset();
                document.getElementById('assignUnitItemId').value = itemId;
                document.getElementById('assignUnitUnitId').value = unitId;
                
                if (isTool) {
                    assignUnitModalTitle.textContent = `Emprestar Unidade ${unitId}`;
                    const toInput = document.createElement('input');
                    toInput.type = 'text';
                    toInput.id = 'assignUnitTo';
                    toInput.className = 'mt-1 block w-full px-3 py-2 border rounded-md shadow-sm';
                    toInput.required = true;
                    assignUnitToLabel.textContent = 'Emprestar para:';
                    assignUnitToContainer.innerHTML = '';
                    assignUnitToContainer.appendChild(toInput);
                    
                    assignUnitPeriodContainer.classList.remove('hidden');
                    assignUnitIdentifierContainer.classList.add('hidden');
                } else {
                    assignUnitModalTitle.textContent = `Atribuir Unidade ${unitId}`;
                    assignUnitToLabel.textContent = 'Atribuir à Frota:';
                    
                    const fleetSelect = document.createElement('select');
                    fleetSelect.id = 'assignUnitTo';
                    fleetSelect.className = 'mt-1 block w-full px-3 py-2 border rounded-md shadow-sm';
                    fleets.forEach(fleet => {
                        const option = document.createElement('option');
                        option.value = fleet.chassi;
                        option.textContent = `${fleet.name} (${fleet.model})`;
                        fleetSelect.appendChild(option);
                    });
                    
                    assignUnitToContainer.innerHTML = '';
                    assignUnitToContainer.appendChild(fleetSelect);
                    
                    assignUnitPeriodContainer.classList.add('hidden');
                    assignUnitIdentifierContainer.classList.remove('hidden');
                }
                
                assignUnitModal.classList.remove('hidden');
            };
            const closeAssignUnitModal = () => assignUnitModal.classList.add('hidden');
            
            const openUserManagementModal = () => {
                adminRoleOption.classList.toggle('hidden', currentUser.username !== SUPER_ADMIN_USERNAME);
                renderUserList();
                userManagementModal.classList.remove('hidden');
            };
            const closeUserManagementModal = () => userManagementModal.classList.add('hidden');

            const openHistoryModal = (item) => {
                historyItemName.textContent = `${item.name} (ID: ${item.id})`;
                historyLogBody.innerHTML = '';
                if (item.history && item.history.length > 0) {
                    item.history.forEach(log => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-3">${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                            <td class="py-2 px-3">${log.user}</td>
                            <td class="py-2 px-3 font-semibold">${log.action}</td>
                            <td class="py-2 px-3">${log.details}</td>
                        `;
                        historyLogBody.appendChild(row);
                    });
                } else {
                    historyLogBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Nenhum histórico para este item.</td></tr>`;
                }
                historyModal.classList.remove('hidden');
            };
            const closeHistoryModal = () => historyModal.classList.add('hidden');

            const openDeletedItemsModal = () => {
                deletedItemsBody.innerHTML = '';
                const deletedItems = inventoryItems.filter(item => item.isDeleted);
                if (deletedItems.length > 0) {
                    deletedItems.forEach(item => {
                        const deletionRecord = item.history.find(h => h.action === 'Exclusão');
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="py-2 px-3">${item.id}</td>
                            <td class="py-2 px-3">${item.name}</td>
                            <td class="py-2 px-3">${deletionRecord ? deletionRecord.user : 'N/A'}</td>
                            <td class="py-2 px-3">${deletionRecord ? new Date(deletionRecord.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                        `;
                        deletedItemsBody.appendChild(row);
                    });
                } else {
                    deletedItemsBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Nenhum item excluído.</td></tr>`;
                }
                deletedItemsModal.classList.remove('hidden');
            };
            const closeDeletedItemsModal = () => deletedItemsModal.classList.add('hidden');

            const openNotificationsModal = (overdueLoans) => {
                notificationsList.innerHTML = '';
                if (overdueLoans.length === 0) {
                    notificationsList.innerHTML = '<p class="text-center">Nenhum empréstimo vencido.</p>';
                } else {
                    overdueLoans.forEach(loan => {
                        const notificationDiv = document.createElement('div');
                        notificationDiv.className = 'p-3 border rounded-md mb-2 bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-500/30';
                        notificationDiv.innerHTML = `
                            <p class="font-semibold text-red-800 dark:text-red-300">${loan.itemName} (Unidade ${loan.unitId})</p>
                            <p class="text-sm text-red-700 dark:text-red-400">Emprestado para: <strong>${loan.lentTo}</strong></p>
                            <p class="text-sm text-red-700 dark:text-red-400">Venceu há: <strong>${loan.daysOverdue} dia(s)</strong></p>
                        `;
                        notificationsList.appendChild(notificationDiv);
                    });
                }
                notificationsModal.classList.remove('hidden');
            };
            const closeNotificationsModal = () => notificationsModal.classList.add('hidden');


            // --- Manipuladores de Eventos ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const users = getUsers();
                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    checkAuth();
                } else {
                    alert('Usuário ou senha inválidos.');
                }
            });

            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                checkAuth();
            });

            // Eventos para filtros e ordenação
            searchInput.addEventListener('input', renderTable);
            filterType.addEventListener('change', renderTable);
            sortBy.addEventListener('change', () => {
                updateSortIcon();
                renderTable();
            });
            sortOrderBtn.addEventListener('click', () => {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                updateSortIcon();
                renderTable();
            });
            
            const updateSortIcon = () => {
                const isSortById = sortBy.value === 'id';
                if (currentSortOrder === 'asc') {
                    sortOrderIcon.className = isSortById ? 'fas fa-arrow-down-1-9' : 'fas fa-arrow-down-a-z';
                } else {
                    sortOrderIcon.className = isSortById ? 'fas fa-arrow-up-9-1' : 'fas fa-arrow-up-z-a';
                }
            };

            manageUsersBtn.addEventListener('click', openUserManagementModal);
            closeUserManagementBtn.addEventListener('click', closeUserManagementModal);
            viewDeletedBtn.addEventListener('click', openDeletedItemsModal);
            closeDeletedItemsBtn.addEventListener('click', closeDeletedItemsModal);

            registerUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUsername = document.getElementById('newUsername').value;
                const newPassword = document.getElementById('newPassword').value;
                const newUserRole = document.getElementById('newUserRole').value;
                let users = getUsers();

                if (users.some(u => u.username === newUsername)) {
                    alert('Este nome de usuário já existe.');
                    return;
                }

                users.push({ username: newUsername, password: newPassword, role: newUserRole });
                saveUsers(users);
                alert(`Usuário '${newUsername}' cadastrado com sucesso!`);
                registerUserForm.reset();
                renderUserList();
            });
            
            addItemBtn.addEventListener('click', () => openItemModal());
            cancelItemBtn.addEventListener('click', closeItemModal);
            cancelStockBtn.addEventListener('click', closeStockModal);
            closeUnitManagementBtn.addEventListener('click', closeUnitManagementModal);
            cancelAssignUnitBtn.addEventListener('click', closeAssignUnitModal);
            closeHistoryBtn.addEventListener('click', closeHistoryModal);

            itemTypeSelect.addEventListener('change', (e) => {
                itemClassContainer.classList.toggle('hidden', e.target.value !== 'atribuido');
            });

            itemImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageBase64 = e.target.result;
                        imagePreview.src = imageBase64;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            itemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const originalId = document.getElementById('originalItemId').value;
                const newId = document.getElementById('itemId').value;
                const name = document.getElementById('itemName').value;
                const quantity = parseInt(document.getElementById('itemQuantity').value);
                const type = document.getElementById('itemType').value;
                const itemClass = document.getElementById('itemClass').value;

                if (originalId !== newId && inventoryItems.some(i => i.id === newId)) {
                    alert('Este ID já foi utilizado. Por favor, escolha outro.');
                    return;
                }

                if (originalId) { // Atualizar item
                    const item = inventoryItems.find(i => i.id == originalId);
                    if (item) {
                        let changes = [];
                        if (item.id !== newId) changes.push(`ID alterado de '${item.id}' para '${newId}'`);
                        if (item.name !== name) changes.push(`Nome alterado de '${item.name}' para '${name}'`);
                        if (item.type !== type) changes.push(`Tipo alterado de '${item.type}' para '${type}'`);
                        if (item.class !== itemClass) changes.push(`Classe alterada para '${itemClass}'`);
                        
                        if ((item.type === 'atribuido' || item.type === 'ferramenta') && item.quantity !== quantity) {
                            const oldQty = item.quantity;
                            const inUseUnits = item.units.filter(u => u.status !== 'disponivel').length;
                            if (quantity < inUseUnits) {
                                alert(`Não é possível reduzir a quantidade para ${quantity}, pois existem ${inUseUnits} unidades atualmente em uso.`);
                                return;
                            }
                            changes.push(`Quantidade alterada de '${oldQty}' para '${quantity}'`);
                            const diff = quantity - item.units.length;
                            if (diff > 0) {
                                for (let i = 0; i < diff; i++) {
                                    item.units.push({ unitId: item.units.length + 1, status: 'disponivel' });
                                }
                            } else if (diff < 0) {
                                let toRemove = Math.abs(diff);
                                item.units = item.units.filter(unit => {
                                    if (unit.status === 'disponivel' && toRemove > 0) {
                                        toRemove--;
                                        return false;
                                    }
                                    return true;
                                });
                            }
                        } else if (item.quantity !== quantity) {
                             changes.push(`Quantidade alterada de '${item.quantity}' para '${quantity}'`);
                        }
                        
                        if (changes.length > 0) {
                            addHistoryRecord(item, 'Edição', changes.join(', '));
                        }

                        item.id = newId;
                        item.name = name;
                        item.quantity = quantity;
                        item.type = type;
                        if (type === 'atribuido') item.class = itemClass;
                        item.imageData = imageBase64 || item.imageData;
                    }
                } else { // Adicionar item
                    const newItem = {
                        id: newId, name, quantity, type, imageData: imageBase64, history: [], isDeleted: false
                    };
                    if (type === 'ferramenta' || type === 'atribuido') {
                        newItem.units = [];
                        for (let i = 1; i <= quantity; i++) {
                            newItem.units.push({ unitId: i, status: 'disponivel' });
                        }
                    }
                    if (type === 'atribuido') {
                        newItem.class = itemClass;
                    }
                    addHistoryRecord(newItem, 'Criação', `Item criado com ${quantity} unidades.`);
                    inventoryItems.push(newItem);
                }
                saveInventory();
                loadInventory();
                closeItemModal();
            });
            
            stockForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('stockItemId').value;
                const type = document.getElementById('stockType').value;
                const quantity = parseInt(document.getElementById('stockQuantity').value);
                
                const item = inventoryItems.find(i => i.id == id);
                if (item) {
                    if (type === 'Saída' && item.quantity < quantity) {
                        alert('Quantidade de saída excede o estoque atual.');
                        return;
                    }
                    
                    const oldQty = item.quantity;
                    item.quantity = type === 'Entrada' ? item.quantity + quantity : item.quantity - quantity;
                    const details = `Quantidade: ${quantity}. Estoque alterado de ${oldQty} para ${item.quantity}.`;
                    addHistoryRecord(item, type, details);
                    
                    saveInventory();
                    loadInventory();
                    closeStockModal();
                }
            });

            assignUnitForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemId = document.getElementById('assignUnitItemId').value;
                const unitId = parseInt(document.getElementById('assignUnitUnitId').value);
                const to = document.getElementById('assignUnitTo').value;
                const period = document.getElementById('assignUnitPeriod').value;
                const isIndefinite = document.getElementById('assignUnitIndefinite').checked;
                const identifier = document.getElementById('assignUnitIdentifier').value;

                const item = inventoryItems.find(i => i.id === itemId);
                const unit = item.units.find(u => u.unitId === unitId);

                if (item.type === 'ferramenta') {
                    unit.status = 'emprestada';
                    unit.lentTo = to;
                    unit.loanDate = new Date().toISOString();
                    if (isIndefinite) {
                        unit.dueDate = 'Indefinido';
                        addHistoryRecord(item, 'Empréstimo', `Unidade ${unitId} emprestada para ${to} (prazo indefinido).`);
                    } else {
                        unit.dueDate = period;
                        addHistoryRecord(item, 'Empréstimo', `Unidade ${unitId} emprestada para ${to} (devolução em ${new Date(period).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}).`);
                    }
                } else { // Atribuído
                    const fleet = fleets.find(f => f.chassi === to);
                    
                    // *** CORREÇÃO DA LÓGICA DE ATRIBUIÇÃO ***
                    // Verifica se a frota de destino já possui QUALQUER item da mesma classe.
                    const fleetHasClassAssigned = inventoryItems.some(invItem => 
                        invItem.type === 'atribuido' &&
                        invItem.class && // Garante que a classe exista
                        invItem.class === item.class &&
                        invItem.units.some(u => u.assignedTo === to)
                    );

                    if (fleetHasClassAssigned) {
                        alert(`Erro: A frota '${fleet.name}' já possui um item da classe '${item.class}' atribuído. Não é possível atribuir múltiplos itens da mesma classe à mesma frota.`);
                        return;
                    }

                    unit.status = 'atribuido';
                    unit.assignedTo = to;
                    unit.identifier = identifier;
                    addHistoryRecord(item, 'Atribuição', `Unidade ${unitId} (ID: ${identifier}) atribuída a ${fleet.name}.`);
                }

                saveInventory();
                loadInventory();
                openUnitManagementModal(item);
                closeAssignUnitModal();
            });

            // --- Funções Globais para Ações da Tabela ---
            window.handleEdit = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openItemModal(item);
            };

            window.handleDelete = (id) => {
                if (confirm('Tem certeza que deseja remover este item? Ele será movido para o log de excluídos.')) {
                    const itemIndex = inventoryItems.findIndex(i => i.id === id);
                    if (itemIndex > -1) {
                        inventoryItems[itemIndex].isDeleted = true;
                        addHistoryRecord(inventoryItems[itemIndex], 'Exclusão', 'Item marcado como excluído.');
                        saveInventory();
                        renderTable();
                    }
                }
            };
            
            window.handleStock = (id, type) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openStockModal(item, type);
            };

            window.handleManageUnits = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if(item) openUnitManagementModal(item);
            };

            window.handleLendUnit = (itemId, unitId) => {
                openAssignUnitModal(itemId, unitId, true);
            };

            window.handleReturnUnit = (itemId, unitId) => {
                const item = inventoryItems.find(i => i.id === itemId);
                const unit = item.units.find(u => u.unitId === unitId);
                if (confirm(`Confirmar a devolução da Unidade ${unitId}?`)) {
                    addHistoryRecord(item, 'Devolução', `Unidade ${unitId} devolvida por ${unit.lentTo}.`);
                    unit.status = 'disponivel';
                    delete unit.lentTo;
                    delete unit.loanDate;
                    delete unit.dueDate;
                    saveInventory();
                    loadInventory();
                    openUnitManagementModal(item);
                }
            };

            window.handleAssignUnit = (itemId, unitId) => {
                openAssignUnitModal(itemId, unitId, false);
            };

            window.handleUnassignUnit = (itemId, unitId) => {
                const item = inventoryItems.find(i => i.id === itemId);
                const unit = item.units.find(u => u.unitId === unitId);
                if (confirm(`Remover atribuição da Unidade ${unitId} de ${unit.assignedTo}?`)) {
                    addHistoryRecord(item, 'Remoção de Atribuição', `Atribuição da Unidade ${unitId} (ID: ${unit.identifier}) removida de ${unit.assignedTo}.`);
                    unit.status = 'disponivel';
                    delete unit.assignedTo;
                    delete unit.identifier;
                    saveInventory();
                    loadInventory();
                    openUnitManagementModal(item);
                }
            };

            window.handleHistory = (id) => {
                const item = inventoryItems.find(i => i.id === id);
                if (item) openHistoryModal(item);
            };

            // --- Lógica de Gerenciamento de Usuários ---
            const renderUserList = () => {
                userListDiv.innerHTML = '';
                const users = getUsers();
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex justify-between items-center p-2 border rounded-md';
                    
                    let buttons = '';
                    const canBeManaged = user.username !== SUPER_ADMIN_USERNAME && (currentUser.role === 'admin' || (currentUser.role === 'editor' && user.role !== 'admin'));

                    if (canBeManaged) {
                        buttons = `
                            <button onclick="handleChangeRole('${user.username}')" class="text-blue-500 hover:text-blue-700 text-sm" title="Mudar Papel"><i class="fas fa-user-shield"></i></button>
                            <button onclick="handleDeleteUser('${user.username}')" class="text-red-500 hover:text-red-700 text-sm" title="Excluir Usuário"><i class="fas fa-user-times"></i></button>
                        `;
                    } else if (user.username === currentUser.username) {
                        buttons = '<span class="text-xs">Atual</span>';
                    }

                    userDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${user.username}</p>
                            <p class="text-sm">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                        </div>
                        <div class="flex gap-2">
                            ${buttons}
                        </div>
                    `;
                    userListDiv.appendChild(userDiv);
                });
            };

            window.handleChangeRole = (username) => {
                let users = getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    const newRole = prompt(`Digite o novo papel para '${username}' (admin, editor, user):`, user.role);
                    if (newRole && ['admin', 'editor', 'user'].includes(newRole)) {
                        if (newRole === 'admin' && currentUser.username !== SUPER_ADMIN_USERNAME) {
                            alert('Apenas o admin principal pode designar outros admins.');
                            return;
                        }
                        user.role = newRole;
                        saveUsers(users);
                        renderUserList();
                    } else if (newRole !== null) {
                        alert('Papel inválido.');
                    }
                }
            };

            window.handleDeleteUser = (username) => {
                if (confirm(`Tem certeza que deseja excluir o usuário '${username}'? Esta ação não pode ser desfeita.`)) {
                    let users = getUsers().filter(u => u.username !== username);
                    saveUsers(users);
                    renderUserList();
                }
            };

            // --- Lógica de Exportação ---
            exportBtn.addEventListener('click', () => {
                const activeItems = inventoryItems.filter(item => !item.isDeleted);
                
                const mainData = [];
                const loansData = [];
                const assignmentsData = [];

                activeItems.forEach(item => {
                    const lastChange = item.history ? item.history[0] : null;
                    let statusOrQty = '';

                    if (item.type === 'ferramenta' || item.type === 'atribuido') {
                        const inUseCount = item.units ? item.units.filter(u => u.status !== 'disponivel').length : 0;
                        statusOrQty = `${inUseCount} de ${item.quantity} em uso`;
                        
                        if (item.units) {
                            item.units.forEach(unit => {
                                if (unit.status !== 'disponivel') {
                                    if (item.type === 'ferramenta') {
                                        loansData.push({
                                            'ID do Item': item.id,
                                            'Nome do Item': item.name,
                                            'Unidade': unit.unitId,
                                            'Emprestada para': unit.lentTo,
                                            'Data Devolução': unit.dueDate === 'Indefinido' ? 'Indefinido' : new Date(unit.dueDate).toLocaleDateString('pt-BR')
                                        });
                                    } else { // Atribuído
                                        const fleet = fleets.find(f => f.chassi === unit.assignedTo);
                                        assignmentsData.push({
                                            'ID do Item': item.id,
                                            'Nome do Item': item.name,
                                            'Classe': item.class || '',
                                            'Unidade': unit.unitId,
                                            'Nº de Série': unit.identifier || '',
                                            'Atribuído a Frota': fleet ? fleet.name : unit.assignedTo,
                                            'Chassi da Frota': unit.assignedTo
                                        });
                                    }
                                }
                            });
                        }
                    } else {
                        statusOrQty = item.quantity;
                    }

                    mainData.push({
                        'ID': item.id,
                        'Nome': item.name,
                        'Tipo': item.type,
                        'Classe (se aplicável)': item.class || '',
                        'Status/Qtd': statusOrQty,
                        'Última Alteração Por': lastChange ? lastChange.user : '',
                        'Data/Hora': lastChange ? new Date(lastChange.timestamp).toLocaleString('pt-BR') : ''
                    });
                });

                const wb = XLSX.utils.book_new();
                const wsMain = XLSX.utils.json_to_sheet(mainData);
                XLSX.utils.book_append_sheet(wb, wsMain, "Inventário Geral");

                if (loansData.length > 0) {
                    const wsLoans = XLSX.utils.json_to_sheet(loansData);
                    XLSX.utils.book_append_sheet(wb, wsLoans, "Empréstimos Ativos");
                }
                if (assignmentsData.length > 0) {
                    const wsAssignments = XLSX.utils.json_to_sheet(assignmentsData);
                    XLSX.utils.book_append_sheet(wb, wsAssignments, "Atribuições Ativas");
                }
                
                XLSX.writeFile(wb, "inventario_detalhado.xlsx");
            });
            
            // --- Lógica de Notificações ---
            const updateNotifications = () => {
                const overdueLoans = [];
                const now = new Date();
                now.setHours(0, 0, 0, 0); 

                inventoryItems.forEach(item => {
                    if (item.type === 'ferramenta' && item.units) {
                        item.units.forEach(unit => {
                            if (unit.status === 'emprestada' && unit.dueDate && unit.dueDate !== 'Indefinido') {
                                const dueDate = new Date(unit.dueDate);
                                if (now > dueDate) {
                                    const diffTime = Math.abs(now - dueDate);
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    overdueLoans.push({
                                        itemName: item.name,
                                        unitId: unit.unitId,
                                        lentTo: unit.lentTo,
                                        daysOverdue: diffDays
                                    });
                                }
                            }
                        });
                    }
                });

                if (overdueLoans.length > 0) {
                    notificationBadge.textContent = overdueLoans.length;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
                
                notificationsBtn.onclick = () => openNotificationsModal(overdueLoans);
            };

            closeNotificationsBtn.addEventListener('click', closeNotificationsModal);

            window.handleExtendLoan = (itemId, unitId) => {
                const newDate = prompt("Digite a nova data de devolução (AAAA-MM-DD):");
                if (newDate) {
                    const item = inventoryItems.find(i => i.id === itemId);
                    const unit = item.units.find(u => u.unitId === unitId);
                    
                    unit.dueDate = newDate;
                    
                    addHistoryRecord(item, 'Prorrogação', `Empréstimo da Unidade ${unitId} prorrogado para ${new Date(newDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}.`);
                    saveInventory();
                    loadInventory();
                    openUnitManagementModal(item);
                }
            };
            
            // --- Lógica de Frotas ---
            manageFleetsBtn.addEventListener('click', () => {
                renderFleetList();
                fleetManagementModal.classList.remove('hidden');
            });
            closeFleetManagementBtn.addEventListener('click', () => fleetManagementModal.classList.add('hidden'));

            fleetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const originalChassi = document.getElementById('originalChassi').value;
                const fleetData = {
                    name: document.getElementById('fleetName').value,
                    model: document.getElementById('fleetModel').value,
                    chassi: document.getElementById('fleetChassi').value
                };

                if (originalChassi) { // Editando
                    const index = fleets.findIndex(f => f.chassi === originalChassi);
                    fleets[index] = fleetData;
                } else { // Adicionando
                    if (fleets.some(f => f.chassi === fleetData.chassi)) {
                        alert("Erro: Já existe uma frota com este Chassi.");
                        return;
                    }
                    fleets.push(fleetData);
                }
                saveFleets();
                fleetForm.reset();
                document.getElementById('originalChassi').value = '';
                renderFleetList();
            });

            const renderFleetList = () => {
                fleetList.innerHTML = '';
                fleets.forEach(fleet => {
                    const fleetDiv = document.createElement('div');
                    fleetDiv.className = 'flex justify-between items-center p-2 border rounded-md';
                    fleetDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${fleet.name} (${fleet.model})</p>
                            <p class="text-sm">Chassi: ${fleet.chassi}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleEditFleet('${fleet.chassi}')" class="text-blue-500 hover:text-blue-700 text-sm" title="Editar Frota"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDeleteFleet('${fleet.chassi}')" class="text-red-500 hover:text-red-700 text-sm" title="Excluir Frota"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    fleetList.appendChild(fleetDiv);
                });
            };

            window.handleEditFleet = (chassi) => {
                const fleet = fleets.find(f => f.chassi === chassi);
                if (fleet) {
                    document.getElementById('originalChassi').value = fleet.chassi;
                    document.getElementById('fleetName').value = fleet.name;
                    document.getElementById('fleetModel').value = fleet.model;
                    document.getElementById('fleetChassi').value = fleet.chassi;
                }
            };
            
            window.handleDeleteFleet = (chassi) => {
                if (confirm(`Tem certeza que deseja excluir a frota com chassi ${chassi}?`)) {
                    fleets = fleets.filter(f => f.chassi !== chassi);
                    saveFleets();
                    renderFleetList();
                }
            };
            
            // --- Nova Lógica para Visualização de Frotas ---
            viewFleetsBtn.addEventListener('click', () => {
                fleetsViewList.innerHTML = ''; // Limpa a lista
                
                if (fleets.length === 0) {
                    fleetsViewList.innerHTML = '<p class="text-center">Nenhuma frota cadastrada.</p>';
                } else {
                    fleets.forEach(fleet => {
                        const assignedItems = inventoryItems.filter(item => 
                            item.type === 'atribuido' &&
                            item.units.some(unit => unit.assignedTo === fleet.chassi)
                        );

                        let itemsHTML = '<p class="text-sm pl-4">Nenhum item atribuído.</p>';
                        if (assignedItems.length > 0) {
                            itemsHTML = '<ul class="list-disc pl-8 text-sm space-y-1 mt-2">';
                            assignedItems.forEach(item => {
                                item.units.forEach(unit => {
                                    if (unit.assignedTo === fleet.chassi) {
                                        itemsHTML += `<li><strong>${item.name}</strong> (Classe: ${item.class || 'N/D'}) - Nº Série: ${unit.identifier || 'N/A'}</li>`;
                                    }
                                });
                            });
                            itemsHTML += '</ul>';
                        }
                        
                        const fleetAccordion = document.createElement('div');
                        fleetAccordion.className = 'border rounded-lg overflow-hidden';
                        fleetAccordion.innerHTML = `
                            <button class="w-full text-left p-4 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                <div>
                                    <p class="font-bold">${fleet.name} (${fleet.model})</p>
                                    <p class="text-xs">Chassi: ${fleet.chassi}</p>
                                </div>
                                <i class="fas fa-chevron-down transform transition-transform"></i>
                            </button>
                            <div class="p-4 border-t hidden">
                                ${itemsHTML}
                            </div>
                        `;
                        fleetsViewList.appendChild(fleetAccordion);
                    });
                }
                
                fleetsViewModal.classList.remove('hidden');
            });
            closeFleetsViewBtn.addEventListener('click', () => fleetsViewModal.classList.add('hidden'));

            // --- Lógica do Tema ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeToggleLightIcon.classList.remove('hidden');
                    themeToggleDarkIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggleDarkIcon.classList.remove('hidden');
                    themeToggleLightIcon.classList.add('hidden');
                }
            };

            themeToggleButton.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                const newTheme = isDark ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            
            // --- Inicialização ---
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            initializeAdmin();
            checkAuth();
            updateSortIcon();
        });
    </script>
</body>
</html>
